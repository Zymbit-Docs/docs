<!doctype html><html lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=generator content="Hugo 0.79.1"><meta name=ROBOTS content="NOINDEX, NOFOLLOW"><link rel="shortcut icon" href=/favicons/favicon.ico><link rel=apple-touch-icon href=/favicons/apple-touch-icon.png sizes=180x180><link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16><link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32><link rel=icon type=image/png href=/favicons/android-chrome-192x192.png sizes=192x192><link rel=icon type=image/png href=/favicons/android-chrome-512x512.png sizes=512x512><title>AWS IoT - Just in Time Registration of Client Certificates using Lambda functions |</title><meta name=description content><meta property="og:title" content="AWS IoT - Just in Time Registration of Client Certificates using Lambda functions"><meta property="og:description" content="How to automatically generate a client certificate, register your own CA, and authenticate a device to establish a TLS connection to AWS IoT  Overview AWS IoT requires an IoT device to register and activate a certificate with AWS before communicating. For large scale deployments, AWS provides an automated process called Just-In-Time-Registration. This allows a user to register a Certificate Authority with AWS so that upon a device&rsquo;s first TLS connection to AWS servers, if the device certificate was signed by this Certificate Authority, the certificate will be quickly activated by a lambda-function and be ready to use."><meta property="og:type" content="article"><meta property="og:url" content="https://docs.zymbit.com/tutorials/aws-iot/jitr/"><meta property="og:image" content="https://docs.zymbit.com/doks.png"><meta property="article:modified_time" content="2021-09-02T18:32:38-04:00"><meta property="og:site_name" content="Zymbit Documentation"><meta itemprop=name content="AWS IoT - Just in Time Registration of Client Certificates using Lambda functions"><meta itemprop=description content="How to automatically generate a client certificate, register your own CA, and authenticate a device to establish a TLS connection to AWS IoT  Overview AWS IoT requires an IoT device to register and activate a certificate with AWS before communicating. For large scale deployments, AWS provides an automated process called Just-In-Time-Registration. This allows a user to register a Certificate Authority with AWS so that upon a device&rsquo;s first TLS connection to AWS servers, if the device certificate was signed by this Certificate Authority, the certificate will be quickly activated by a lambda-function and be ready to use."><meta itemprop=dateModified content="2021-09-02T18:32:38-04:00"><meta itemprop=wordCount content="2390"><meta itemprop=image content="https://docs.zymbit.com/doks.png"><meta itemprop=keywords content><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://docs.zymbit.com/doks.png"><meta name=twitter:title content="AWS IoT - Just in Time Registration of Client Certificates using Lambda functions"><meta name=twitter:description content="How to automatically generate a client certificate, register your own CA, and authenticate a device to establish a TLS connection to AWS IoT  Overview AWS IoT requires an IoT device to register and activate a certificate with AWS before communicating. For large scale deployments, AWS provides an automated process called Just-In-Time-Registration. This allows a user to register a Certificate Authority with AWS so that upon a device&rsquo;s first TLS connection to AWS servers, if the device certificate was signed by this Certificate Authority, the certificate will be quickly activated by a lambda-function and be ready to use."><link rel=preload href=/scss/main.min.ce0d576b050c303c3365576158e2ded601d798b4493d903e7d9d7c9748c0a182.css as=style><link href=/scss/main.min.ce0d576b050c303c3365576158e2ded601d798b4493d903e7d9d7c9748c0a182.css rel=stylesheet integrity><script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script></head><body class=td-page><header><nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar"><a class=navbar-brand href=/><img class=navbar-logo src=https://docs.zymbit.com/Zymbit-Logo.gif></a><div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar><ul class="navbar-nav mt-2 mt-lg-0"></ul></div><div class="navbar-nav d-none d-lg-block"></div></nav></header><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><div class="col-12 col-md-4 col-xl-3 td-sidebar d-print-none"><div id=td-sidebar-menu class=td-sidebar__inner><form class="td-sidebar__search d-flex align-items-center"><button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation"></button></form><nav class="collapse td-sidebar-nav" id=td-section-nav><ul class="td-sidebar-nav__section pr-md-3 ul-0"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m--li><a href=/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section tree-root" id=m-><span>Welcome to Zymbit Documentation</span></a><ul class="pr-md-3 ul-1"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-quickstart-li><span class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section"><span>QUICKSTART</span></span><ul class="pr-md-3 ul-2"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-quickstartgetting-started-li><a href=/quickstart/getting-started/ title="Getting Started with Zymbit Products" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-quickstartgetting-started><i class="fas fa-caret-right"></i><span>Getting Started</span></a><ul class="pr-md-3 ul-3"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-quickstartgetting-startedzymkey4-li><a href=/quickstart/getting-started/zymkey4/ title="Getting Started with Zymkey4" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-quickstartgetting-startedzymkey4><span>ZYMKEY4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-quickstartgetting-startedhsm4-li><a href=/quickstart/getting-started/hsm4/ title="Getting Started with HSM4" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-quickstartgetting-startedhsm4><span>HSM4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-quickstartgetting-startedhsm6-li><a href=/quickstart/getting-started/hsm6/ title="Getting Started with HSM6" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-quickstartgetting-startedhsm6><span>HSM6</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-quickstartapi-li><a href=/quickstart/api/ title="API Documentation" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-quickstartapi><i class="fas fa-caret-right"></i><span>API</span></a><ul class="pr-md-3 ul-3"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-quickstartapic_api-li><a href=/quickstart/api/c_api/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-quickstartapic_api><span>C API Documentation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-quickstartapicpp_api-li><a href=/quickstart/api/cpp_api/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-quickstartapicpp_api><span>C++ API Documentation</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-quickstartapipython_api-li><a href=/quickstart/api/python_api/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-quickstartapipython_api><span>Python API Documentation</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-quickstartfaq-li><a href=/quickstart/faq/ title="FAQ & Troubleshooting" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-quickstartfaq><i class="fas fa-caret-right"></i><span>FAQ</span></a><ul class="pr-md-3 ul-3"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-quickstartfaqzymkey4-li><a href=/quickstart/faq/zymkey4/ title="Zymkey4 FAQ & Troubleshooting" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-quickstartfaqzymkey4><span>ZYMKEY4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-quickstartfaqhsm4-li><a href=/quickstart/faq/hsm4/ title="HSM4 FAQ & Troubleshooting" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-quickstartfaqhsm4><span>HSM4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-quickstartfaqhsm6-li><a href=/quickstart/faq/hsm6/ title="HSM6 FAQ & Troubleshooting" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-quickstartfaqhsm6><span>HSM6</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-quickstartfaqgeneral-li><a href=/quickstart/faq/general/ title="FAQ & Troubleshooting" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-quickstartfaqgeneral><span>GENERAL</span></a></li></ul></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-reference-li><span class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section"><span>REFERENCE</span></span><ul class="pr-md-3 ul-2"><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referencecad-li><a href=/reference/cad/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-referencecad><i class="fas fa-caret-right"></i><span>CAD</span></a><ul class="pr-md-3 ul-3"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referencecadzymkey4-li><a href=/reference/cad/zymkey4/ title="Zymkey4 CAD Files" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referencecadzymkey4><span>ZYMKEY4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referencecadhsm4-li><a href=/reference/cad/hsm4/ title="HSM4 CAD Files" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referencecadhsm4><span>HSM4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referencecadhsm6-li><a href=/reference/cad/hsm6/ title="HSM6 CAD Files" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referencecadhsm6><span>HSM6</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referenceconformity-li><a href=/reference/conformity/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-referenceconformity><i class="fas fa-caret-right"></i><span>Conformity Documents</span></a><ul class="pr-md-3 ul-3"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referenceconformityzymkey4-li><a href=/reference/conformity/zymkey4/ title="Zymkey4 Conformity Documents" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referenceconformityzymkey4><span>ZYMKEY4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referenceconformityhsm4-li><a href=/reference/conformity/hsm4/ title="HSM4 Conformity Documents" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referenceconformityhsm4><span>HSM4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referenceconformityhsm6-li><a href=/reference/conformity/hsm6/ title="HSM6 Conformity Documents" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referenceconformityhsm6><span>HSM6</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referenceknown-issues-li><a href=/reference/known-issues/ title="Dev Team: Known Issues" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-referenceknown-issues><i class="fas fa-caret-right"></i><span>Known Issues</span></a><ul class="pr-md-3 ul-3"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referenceknown-issuescpu-scaling-li><a href=/reference/known-issues/cpu-scaling/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referenceknown-issuescpu-scaling><span>CPU Scaling Governor</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencepower-quality-li><a href=/reference/power-quality/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-referencepower-quality><i class="fas fa-genderless"></i><span>Power Quality Considerations</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referenceproduct-briefs-li><a href=/reference/product-briefs/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-referenceproduct-briefs><i class="fas fa-caret-right"></i><span>Product Briefs</span></a><ul class="pr-md-3 ul-3"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referenceproduct-briefszymkey4-li><a href=https://www.zymbit.com/datasheets/zymkey-4i target=_blank rel=noopener class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referenceproduct-briefszymkey4><span>ZYMKEY4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referenceproduct-briefshsm4-li><a href=https://www.zymbit.com/datasheets/hsm4 target=_blank rel=noopener class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referenceproduct-briefshsm4><span>HSM4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referenceproduct-briefshsm6-li><a href=https://www.zymbit.com/datasheets/hsm6 target=_blank rel=noopener class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referenceproduct-briefshsm6><span>HSM6</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-referenceproduct-briefsmfg-app-li><a href=https://www.zymbit.com/datasheets/manufacturing-appliance-1 target=_blank rel=noopener class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-referenceproduct-briefsmfg-app><span>Manufacturing Appliance</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencereal-time-clock-li><a href=/reference/real-time-clock/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-referencereal-time-clock><i class="fas fa-genderless"></i><span>Real Time Clock Operation</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-tutorials-li><span class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section"><span>TUTORIALS</span></span><ul class="pr-md-3 ul-2"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsalternative-gpio-li><a href=/tutorials/alternative-gpio/ title="Using an Alternative GPIO Pin" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-tutorialsalternative-gpio><i class="fas fa-genderless"></i><span>Alternative GPIO Pin</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsdigital-wallet-li><a href=/tutorials/digital-wallet/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-tutorialsdigital-wallet><i class="fas fa-genderless"></i><span>Digital Wallet</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-tutorialsencrypt-rfs-li><a href=/tutorials/encrypt-rfs/ title="Encrypting your Root File System with dm-crypt and LUKS" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-tutorialsencrypt-rfs><i class="fas fa-caret-right"></i><span>Encrypt Root File System</span></a><ul class="pr-md-3 ul-3"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-tutorialsencrypt-rfszymkey4-li><a href=/tutorials/encrypt-rfs/zymkey4/ title="Encrypting Root File System with Zymkey4" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-tutorialsencrypt-rfszymkey4><span>ZYMKEY4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-tutorialsencrypt-rfshsm4-li><a href=/tutorials/encrypt-rfs/hsm4/ title="Encrypting Root File System with HSM4" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-tutorialsencrypt-rfshsm4><span>HSM4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-tutorialsencrypt-rfshsm6-li><a href=/tutorials/encrypt-rfs/hsm6/ title="Encrypting Root File System with HSM6" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-tutorialsencrypt-rfshsm6><span>HSM6</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialssensor-data-li><a href=/tutorials/sensor-data/ title="Encrypting & Decrypting Sensor Data on Disk" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-tutorialssensor-data><i class="fas fa-genderless"></i><span>Encrypt Sensor Data</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-tutorialsaws-iot-li><a href=/tutorials/aws-iot/ title="AWS IoT Integrations & Client Certificates" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-tutorialsaws-iot><i class="fas fa-caret-right"></i><span>Integrate Zymbit with AWS</span></a><ul class="pr-md-3 ul-3"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsaws-iotintegrate-li><a href=/tutorials/aws-iot/integrate/ title="How to Integrate Zymbit with AWS Credentials Provider" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-tutorialsaws-iotintegrate><span>Integrate with AWS Credentials Provider</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-tutorialsaws-iotjitr-li><a href=/tutorials/aws-iot/jitr/ title="AWS IoT - Just in Time Registration of Client Certificates using Lambda functions" class="align-left pl-0 pr-2 active td-sidebar-link td-sidebar-link__page" id=m-tutorialsaws-iotjitr><span class=td-sidebar-nav-active-item>Just In Time Registration</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsaws-iottls-li><a href=/tutorials/aws-iot/tls/ title="AWS IoT - TLS Client Certificate Authentication" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-tutorialsaws-iottls><span>Transport Level Security</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsaws-iotverify-sigs-li><a href=/tutorials/aws-iot/verify-sigs/ title="How to Verify Signatures against Public Key on AWS and Other Devices" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-tutorialsaws-iotverify-sigs><span>Verify Signatures</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-tutorialsperimeter-detect-li><a href=/tutorials/perimeter-detect/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-tutorialsperimeter-detect><i class="fas fa-caret-right"></i><span>Perimeter Detect</span></a><ul class="pr-md-3 ul-3"><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-tutorialsperimeter-detectzymkey4-li><a href=/tutorials/perimeter-detect/zymkey4/ title="Perimeter Detect: ZYMKEY4" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-tutorialsperimeter-detectzymkey4><span>ZYMKEY4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-tutorialsperimeter-detecthsm4-li><a href=/tutorials/perimeter-detect/hsm4/ title="Perimeter Detect: HSM4" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-tutorialsperimeter-detecthsm4><span>HSM4</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-tutorialsperimeter-detecthsm6-li><a href=/tutorials/perimeter-detect/hsm6/ title="Perimeter Detect: HSM6" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-tutorialsperimeter-detecthsm6><span>HSM6</span></a></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child collapse" id=m-tutorialsperimeter-detectexamples-li><a href=/tutorials/perimeter-detect/examples/ title="Perimeter Detect Circuit Examples" class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__page" id=m-tutorialsperimeter-detectexamples><span>CIRCUIT EXAMPLES</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsprotokit-li><a href=/tutorials/protokit/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-tutorialsprotokit><i class="fas fa-genderless"></i><span>ProtoKit5</span></a></li></ul></li><li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-forum-li><a href=https://community.zymbit.com/ target=_blank rel=noopener class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section" id=m-forum><span>FORUM</span></a></li></ul></li></ul></nav></div></div><div class="d-none d-xl-block col-xl-2 td-toc d-print-none"><div class="td-page-meta ml-2 pb-1 pt-2 mb-0"></div><nav id=TableOfContents><ul><li><ul><li><ul><li></li></ul></li></ul></li><li><a href=#overview>Overview</a></li><li><a href=#prerequisites>Prerequisites:</a></li><li><a href=#programmatic-setup>Programmatic Setup</a></li><li><a href=#register-certificate-authority-with-aws>Register Certificate Authority with AWS</a><ul><li><a href=#create-ca>Create CA</a></li><li><a href=#register-ca-with-aws>Register CA with AWS</a></li></ul></li><li><a href=#generate-zymkey-certificate>Generate Zymkey Certificate</a></li><li><a href=#creating-the-lambda-function>Creating the Lambda function</a><ul><li><ul><li><a href=#creating-iam-role-for-the-lambda-function>Creating IAM Role for the Lambda function</a></li></ul></li></ul></li><li><a href=#creating-the-aws-iot-rule>Creating the AWS IoT Rule</a></li><li><a href=#testing-jitr-with-tls-connection>Testing JITR with TLS Connection</a></li></ul></nav></div><main class="col-12 col-md-8 col-xl-7 pl-md-5" role=main><nav aria-label=breadcrumb class="d-none d-md-block d-print-none"><ol class="breadcrumb spb-1"><li class=breadcrumb-item><a href=https://docs.zymbit.com/tutorials/>TUTORIALS</a></li><li class=breadcrumb-item><a href=https://docs.zymbit.com/tutorials/aws-iot/>Integrate Zymbit with AWS</a></li><li class="breadcrumb-item active" aria-current=page><a href=https://docs.zymbit.com/tutorials/aws-iot/jitr/>Just In Time Registration</a></li></ol></nav><div class=td-content><h1>AWS IoT - Just in Time Registration of Client Certificates using Lambda functions</h1><h5 id=how-to-automatically-generate-a-client-certificate-register-your-own-ca-and-authenticate-a-device-to-establish-a-tls-connection-to-aws-iot>How to automatically generate a client certificate, register your own CA, and authenticate a device to establish a TLS connection to AWS IoT</h5><hr><h2 id=overview>Overview</h2><p>AWS IoT requires an IoT device to register and activate a certificate with AWS before communicating. For large scale deployments, AWS provides an automated process called <strong>Just-In-Time-Registration</strong>. This allows a user to register a Certificate Authority with AWS so that upon a device&rsquo;s first TLS connection to AWS servers, if the device certificate was signed by this Certificate Authority, the certificate will be quickly activated by a lambda-function and be ready to use.</p><p><img src=aws-iot-jitr.png alt=AWS-IoT-JITR-graphic-2></p><hr><h2 id=prerequisites>Prerequisites:</h2><ul><li>Follow the <a href=https://docs.zymbit.com/quickstart/getting-started/>Getting Started guide</a> first.</li></ul><hr><h2 id=programmatic-setup>Programmatic Setup</h2><p>If you would like to use scripts to register your CA and Lambda function, there are a couple more things to set up. We recommend following the manual approach if your only doing this once or twice.</p><details><summary>Details</summary><br><p>Follow these instructions to set up the <a href=http://boto3.readthedocs.io/en/latest/guide/quickstart.html>boto3 module</a> for Python:</p><p>The boto3 module authenticates with AWS based on a IAM Access ID and Secret Key. The boto3 tutorial will ask you to setup an IAM user, here are some instructions on how to do so:</p><ol><li>From the <strong>AWS console</strong>, choose the <strong>IAM service</strong>.</li><li>Go to <strong>Users</strong> and select <strong>Add User</strong></li><li>Choose a <strong>username</strong> and check the <strong>Programmatic access box</strong></li><li>For simplicity, choose <strong>Attach existing policies directly</strong> and select <strong>AdministratorAccess</strong></li><li>If you wish to better manage your IAM credentials, feel free to customize your Access Policy.</li><li>Click <strong>Review</strong> and then <strong>Create User</strong></li><li><strong>Save the Access ID and Secret Key</strong> and <strong>follow the boto3 guide</strong>.</li></ol></details><hr><h2 id=register-certificate-authority-with-aws>Register Certificate Authority with AWS</h2><p>The following section will show how to generate your own CA using OpenSSL and register it with your AWS account.</p><details><summary>Details</summary><br><h3 id=create-ca>Create CA</h3><p><strong>Copy the lines below into a script called mk_ca.sh.</strong></p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span><span class=nb>set</span> -e
mkdir CA_files
<span class=nb>cd</span> CA_files

openssl ecparam -genkey -name prime256v1 -out zk_ca.key
<span class=nv>OPENSSL_CONF</span><span class=o>=</span>/etc/ssl/openssl.cnf openssl req <span class=se>\
</span><span class=se></span>  -x509 -new -SHA256 -nodes -key zk_ca.key <span class=se>\
</span><span class=se></span>  -days <span class=m>3650</span> -out zk_ca.crt <span class=se>\
</span><span class=se></span>  -subj <span class=s2>&#34;/C=US/ST=California/L=Santa Barbara/O=Zymkey/CN=zymkey-verify.zymbit.com.dev&#34;</span>

cp zk_ca.crt zk_ca.pem
</code></pre></div><p><strong>You can then run the script in the command line by being in the same directory with the following command:</strong></p><pre><code>bash mk_ca.sh
</code></pre><p><strong>The script will create a directory called CA_files and a couple of files:</strong>
zk_ca.key: Private key for the created CA, will be supplied to OpenSSL for signing CSRs.
zk_ca.pem: PEM formatted certificate for the CA
zk_ca.crt: Same file as zk_ca.pem</p><hr><h3 id=register-ca-with-aws>Register CA with AWS</h3><p><strong>Manually</strong>:</p><ol><li><p>From the <strong>AWS IoT console</strong> select <strong>Secure</strong> then <strong>CA</strong> and then click <strong>Register</strong></p></li><li><p>Click <strong>register CA</strong></p></li><li><p>Follow the directions on the following screen to create a verification certificate.</p></li><li><p>When signing the verification certificate with your CA in <strong>Step 4</strong> run the following command:</p><pre><code> openssl x509 -req -in verificationCert.csr -CA CA_files/zk_ca.pem -CAkey CA_files/zk_ca.key -CAcreateserial -out verificationCert.crt -days 500 -sha256
</code></pre><p>Note that if you a different CA and not the demo one we generated, to change the <strong>-CA</strong> and <strong>-CAkey</strong> paths appropriately.</p></li><li><p>Click <strong>Select CA certificate</strong> and point to the correct <strong>.pem file</strong>. If you use the OpenSSL generated SSL point to <strong>CA_files/zk_ca.pem</strong></p></li><li><p>Click <strong>Select verification certificate</strong> and point to <strong>verificationCert.crt</strong> which was created in Step 4.</p></li><li><p>Select <strong>Active CA certificate</strong> and <strong>Enable auto-registration of device certificates</strong></p></li></ol><hr><p><strong>Programatically:</strong>
The following python script will <strong>automatically create a verification cert with a registration code</strong> and <strong>automatically active your Certificate Authority</strong>. While it may look a bit intimidating, all you have to worry about is the <strong>very last line</strong>, where you can <strong>change to point to your CA files</strong>.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>OpenSSL</span>
<span class=kn>import</span> <span class=nn>boto3</span>
<span class=kn>import</span> <span class=nn>os</span>

<span class=k>def</span> <span class=nf>gen_AWS_verification_csr</span><span class=p>(</span><span class=n>registrationCode</span><span class=p>):</span>
	<span class=n>key</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>PKey</span><span class=p>()</span>
	<span class=n>key</span><span class=o>.</span><span class=n>generate_key</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>TYPE_RSA</span><span class=p>,</span> <span class=mi>2048</span><span class=p>)</span>
	<span class=n>req</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>X509Req</span><span class=p>()</span>
	<span class=n>req</span><span class=o>.</span><span class=n>get_subject</span><span class=p>()</span><span class=o>.</span><span class=n>CN</span> <span class=o>=</span> <span class=n>registrationCode</span>
	<span class=n>req</span><span class=o>.</span><span class=n>set_pubkey</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
	<span class=n>req</span><span class=o>.</span><span class=n>sign</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=s2>&#34;sha256&#34;</span><span class=p>)</span>	
	<span class=k>return</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>dump_certificate_request</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>FILETYPE_PEM</span><span class=p>,</span> <span class=n>req</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>sign_CSR_with_CA</span><span class=p>(</span><span class=n>verification_csr</span><span class=p>,</span> <span class=n>CA_cert_path</span><span class=p>,</span> <span class=n>CA_key_path</span><span class=p>):</span>
	<span class=n>ca_cert</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>load_certificate</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>FILETYPE_PEM</span><span class=p>,</span> <span class=nb>open</span><span class=p>(</span><span class=n>CA_cert_path</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
	<span class=n>ca_key</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>load_privatekey</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>FILETYPE_PEM</span><span class=p>,</span> <span class=nb>open</span><span class=p>(</span><span class=n>CA_key_path</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
	<span class=n>req</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>load_certificate_request</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>FILETYPE_PEM</span><span class=p>,</span> <span class=n>verification_csr</span><span class=p>)</span>
	<span class=n>cert</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>X509</span><span class=p>()</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>set_subject</span><span class=p>(</span><span class=n>req</span><span class=o>.</span><span class=n>get_subject</span><span class=p>())</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>set_serial_number</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>gmtime_adj_notBefore</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>gmtime_adj_notAfter</span><span class=p>(</span><span class=mi>24</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>set_issuer</span><span class=p>(</span><span class=n>ca_cert</span><span class=o>.</span><span class=n>get_subject</span><span class=p>())</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>set_pubkey</span><span class=p>(</span><span class=n>req</span><span class=o>.</span><span class=n>get_pubkey</span><span class=p>())</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>sign</span><span class=p>(</span><span class=n>ca_key</span><span class=p>,</span> <span class=s2>&#34;sha256&#34;</span><span class=p>)</span>
	<span class=k>return</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>dump_certificate</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>FILETYPE_PEM</span><span class=p>,</span> <span class=n>cert</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>register_CA_AWS</span><span class=p>(</span><span class=n>CA_cert_path</span><span class=p>,</span> <span class=n>CA_key_path</span><span class=p>):</span>
	<span class=n>client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;iot&#39;</span><span class=p>)</span>
	
	<span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_registration_code</span><span class=p>()</span>
	<span class=n>registration_key</span> <span class=o>=</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;registrationCode&#39;</span><span class=p>]</span>
	
	<span class=n>verification_pem</span> <span class=o>=</span> <span class=n>gen_AWS_verification_csr</span><span class=p>(</span><span class=n>registrationCode</span><span class=o>=</span><span class=n>registration_key</span><span class=p>)</span>
	<span class=n>verification_cert</span> <span class=o>=</span> <span class=n>sign_CSR_with_CA</span><span class=p>(</span><span class=n>verification_csr</span><span class=o>=</span><span class=n>verification_pem</span><span class=p>,</span> <span class=n>CA_cert_path</span><span class=o>=</span><span class=n>CA_cert_path</span><span class=p>,</span> <span class=n>CA_key_path</span><span class=o>=</span><span class=n>CA_key_path</span><span class=p>)</span>
	
	<span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>register_ca_certificate</span><span class=p>(</span>
		<span class=n>caCertificate</span><span class=o>=</span><span class=nb>open</span><span class=p>(</span><span class=n>CA_cert_path</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>(),</span>
		<span class=n>verificationCertificate</span><span class=o>=</span><span class=n>verification_cert</span><span class=p>,</span>
		<span class=n>setAsActive</span><span class=o>=</span><span class=bp>True</span><span class=p>,</span>
		<span class=n>allowAutoRegistration</span><span class=o>=</span><span class=bp>True</span>
	<span class=p>)</span>

	<span class=k>return</span> <span class=n>response</span>

<span class=n>register_CA_AWS</span><span class=p>(</span><span class=n>CA_cert_path</span><span class=o>=</span><span class=s1>&#39;CA_files/zk_ca.crt&#39;</span><span class=p>,</span> <span class=n>CA_key_path</span><span class=o>=</span><span class=s1>&#39;CA_files/zk_ca.key&#39;</span><span class=p>)</span>	
</code></pre></div><p><strong>Copy the above lines into a file called activate_aws_ca.py and run with the following command:</strong></p><pre><code>python activate_aws_ca.py
</code></pre></details><hr><h2 id=generate-zymkey-certificate>Generate Zymkey Certificate</h2><p>The first thing we will do is generate a device certificate using Zymkey&rsquo;s private key. We will watch as this certificate gets activated on your AWS IoT console automatically on first connect. Make sure that you do not already have a Zymkey certificate registered on your AWS IoT console.</p><p><strong>Generate a Certificate Signing Request with Zymkey&rsquo;s private key using the following command</strong>:</p><pre><code>openssl req -key nonzymkey.key -new -out zymkey.csr -engine zymkey_ssl -keyform e -subj &quot;/C=US/ST=California/L=Santa Barbara/O=Zymbit/OU=Zymkey/CN=rpi.edge.zymbit.com&quot;
</code></pre><p>Note that the <strong>-subj</strong> line can be omitted or modified with your own information. If it is omitted, you will be prompted to enter your information on the command line.</p><p><strong>Signing the CSR to get a valid Zymkey certificate:</strong></p><p>Next we&rsquo;ll sign this CSR with your Certificate Authority. Save the following script in a file called <strong>sign_csr.sh</strong>. Make sure to change the <strong>-CA</strong> and <strong>-CAkey</strong> paths to point to the private key and certificate file for your certificate authority:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span><span class=nb>set</span> -e

<span class=nv>SCRIPT_NAME</span><span class=o>=</span><span class=k>$(</span>basename <span class=nv>$0</span><span class=k>)</span>

<span class=o>[</span> -z <span class=nv>$2</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>SCRIPT_NAME</span><span class=si>}</span><span class=s2> &lt;csr filename&gt; &lt;crt filename&gt;&#34;</span> 1&gt;<span class=p>&amp;</span><span class=m>2</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=m>1</span>

<span class=nv>csr</span><span class=o>=</span><span class=nv>$1</span>
<span class=nv>crt</span><span class=o>=</span><span class=nv>$2</span>
openssl x509 -req -SHA256 -days <span class=m>3650</span> <span class=se>\
</span><span class=se></span>  -CA CA_files/zk_ca.crt -CAkey CA_files/zk_ca.key -CAcreateserial <span class=se>\
</span><span class=se></span>  -in <span class=si>${</span><span class=nv>csr</span><span class=si>}</span> -out <span class=si>${</span><span class=nv>crt</span><span class=si>}</span>
</code></pre></div><p>Now run the script with the following command, where the first argument is the path to your CSR and the second argument the name you wish to give the signed Zymkey Certificate file.</p><pre><code>bash sign_csr.sh zymkey.csr zymkey.crt
</code></pre><hr><h2 id=creating-the-lambda-function>Creating the Lambda function</h2><p>Now we need to create and register the lambda function that will activate new certificates on your AWS account. This can be done either manually or programatically in Python. We&rsquo;ll start with the Manual method as it is simpler and more straightforward.</p><details><summary>Details</summary><br><p><strong>Manually:</strong></p><ol><li>From your <strong>AWS console</strong>, sign in <a href=https://aws.amazon.com/console/>here</a>, choose the <strong>Lambda</strong> service.</li><li>From the <strong>Lambda console</strong>, click on the orange <strong>Create Function</strong> button.</li><li>Click the <strong>Author from Scratch</strong> button.</li><li>Choose an appropriate <strong>function name</strong> and <strong>description</strong>. We will be using <strong>Node.js 12.x</strong> for the runtime environment.</li><li>Click <strong>Create function</strong>.</li><li>Copy the default JITR code from AWS located <a href=https://github.com/awslabs/aws-iot-examples/blob/master/justInTimeRegistration/deviceActivation.js>here</a> into <strong>index.js</strong> under Function code (If pasting doesn&rsquo;t work in their IDE, try Shift+Insert). Make sure that you <strong>change the region defined in the code</strong> to the appropriate value.</li><li>Now scroll to the top and click the <strong>Permissions</strong> tab.</li><li>Under <strong>Execution role</strong>, click <strong>Edit</strong>.</li><li>There should be an existing role listed under Existing role. Click the blue title <strong>View the role on the IAM console.</strong></li><li>This should take you to the IAM console. Click <strong>Attach policies</strong></li><li>Click <strong>Create policy</strong>, then the <strong>JSON</strong> tab.</li><li>Input the following policy</li></ol><pre><code>{ 
   &quot;Version&quot;:&quot;2012-10-17&quot;,
   &quot;Statement&quot;:[ 
      { 
         &quot;Effect&quot;:&quot;Allow&quot;,
         &quot;Action&quot;:[  
            &quot;logs:CreateLogGroup&quot;,
            &quot;logs:CreateLogStream&quot;,
            &quot;logs:PutLogEvents&quot;
         ],
         &quot;Resource&quot;:&quot;arn:aws:logs:*:*:*&quot;
      },
      { 
         &quot;Effect&quot;:&quot;Allow&quot;,
         &quot;Action&quot;:[  
            &quot;iot:UpdateCertificate&quot;,
            &quot;iot:CreatePolicy&quot;,
            &quot;iot:AttachPrincipalPolicy&quot;
         ],
         &quot;Resource&quot;:&quot;*&quot;
      }
   ]
}
</code></pre><ol start=13><li>Click <strong>Review policy</strong>.</li><li>Give the policy an appropriate name (maybe JITR) and click <strong>Create policy</strong>.</li><li>On the left hand bar, click <strong>Roles</strong>.</li><li>Click on your lambda role name. It should start with the function name you defined in step 4, followed by role, then some random characters.</li><li>Click <strong>Attach policies</strong>.</li><li>Click the box next to the policy we just created in step 14.</li><li>Click <strong>Attach policy</strong>.</li><li>Click the X to the right of the old policy titled <strong>AWSLambdaBasicExecutionRole</strong>, and click <strong>Detach</strong>.</li></ol><p><strong>Programatically:</strong>
The creation of an AWS lambda function through python scripts is a little more intricate than the manual proccess and will need to be divided into numerous parts. The creation of the lambda function will be divided into these steps:</p><ol><li>Creating a new IAM role for the lambda function.</li><li>Creating a new Policy for this IAM role.</li><li>Attaching the Policy to the IAM role.</li><li>Create the lambda function, attaching the IAM role to this function.</li></ol><p>&lt;details=&ldquo;Details&rdquo;></p><h4 id=creating-iam-role-for-the-lambda-function>Creating IAM Role for the Lambda function</h4><p>The first thing we need to do is create an IAM Role. This role gives the Lambda function permission to execute and perform its registration of new certificates.</p><p><strong>Creating this IAM role furthermore requires you to specify 2 things</strong>:</p><p><strong>IAM Trust Document</strong>: This is a document that details what AWS resources are allowed to assume this IAM role. Below is an example IAM trust document we will use that allows lambda services to assume this JITR role. Save the document in a file called <strong>trust_document.txt</strong>.</p><pre><code>{
  &quot;Version&quot;: &quot;2012-10-17&quot;,
  &quot;Statement&quot;: [
    {
      &quot;Effect&quot;: &quot;Allow&quot;,
      &quot;Principal&quot;: {
        &quot;Service&quot;: &quot;lambda.amazonaws.com&quot;
      },
      &quot;Action&quot;: &quot;sts:AssumeRole&quot;
    }
  ]
}
</code></pre><p><strong>Role Policy</strong>: This is a document describing what actions an IAM role may take. This policy is created and then attached to whatever role you wish. The following policy will allow the JITR role to create AWS logs as well as register/activate new certificates and attach policies to them. Save the document in a file called <strong>policy_document.txt</strong>.</p><pre><code>{ 
   &quot;Version&quot;:&quot;2012-10-17&quot;,
   &quot;Statement&quot;:[ 
      { 
         &quot;Effect&quot;:&quot;Allow&quot;,
         &quot;Action&quot;:[  
            &quot;logs:CreateLogGroup&quot;,
            &quot;logs:CreateLogStream&quot;,
            &quot;logs:PutLogEvents&quot;
         ],
         &quot;Resource&quot;:&quot;arn:aws:logs:*:*:*&quot;
      },
      { 
         &quot;Effect&quot;:&quot;Allow&quot;,
         &quot;Action&quot;:[  
            &quot;iot:UpdateCertificate&quot;,
            &quot;iot:CreatePolicy&quot;,
            &quot;iot:AttachPrincipalPolicy&quot;
         ],
         &quot;Resource&quot;:&quot;*&quot;
      }
   ]
}
</code></pre><p>Finally, this is the python code that will take care of the creation of the IAM role. The first thing it does is create an IAM role with the specified Trust settings. Then it creates an IAM policy with the aforementioned policy settings. Finally it will attach the policy to the role. This role will be used by the JITR lambda. <strong>By default it&rsquo;ll read the two documents trust_document.txt and policy_document.txt from the same directory that the code is executed in. So save the python script in a file called create_jitr_lambda.py in the same directory as these files, or modify the path to these files in the code. They can be either relative or absolute</strong></p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>boto3</span>
	
<span class=n>iam_client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;IAM&#39;</span><span class=p>)</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;trust_document.txt&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>trust_role</span><span class=p>:</span>
	<span class=n>trust_document</span> <span class=o>=</span> <span class=n>trust_role</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>

<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;policy_document.txt&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>policy</span><span class=p>:</span>
	<span class=n>policy_document</span> <span class=o>=</span> <span class=n>policy</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>

<span class=c1># Creating the IAM role with the specified Trust </span>
<span class=n>create_role_response</span> <span class=o>=</span> <span class=n>iam_client</span><span class=o>.</span><span class=n>create_role</span><span class=p>(</span>
	<span class=n>RoleName</span><span class=o>=</span><span class=s1>&#39;jitr_role&#39;</span><span class=p>,</span>
	<span class=n>AssumeRolePolicyDocument</span><span class=o>=</span><span class=n>trust_document</span><span class=p>,</span>
	<span class=n>Description</span><span class=o>=</span><span class=s1>&#39;AWS Role given to the JITR lambda&#39;</span>
<span class=p>)</span>

<span class=c1># Creating the IAM policy with the specified P</span>
<span class=n>create_policy_resopnse</span> <span class=o>=</span> <span class=n>iam_client</span><span class=o>.</span><span class=n>create_policy</span><span class=p>(</span>
	<span class=n>PolicyName</span><span class=o>=</span><span class=n>policy_name</span><span class=p>,</span>
	<span class=n>PolicyDocument</span><span class=o>=</span><span class=n>policy_document</span><span class=p>,</span>
	<span class=n>Description</span><span class=s1>&#39;Policy that allows JITR lambda to execute actions.&#39;</span>
<span class=p>)</span>	
	
<span class=c1># Attaching the IAM policy to the IAM role	</span>
<span class=n>attach_response</span> <span class=o>=</span> <span class=n>iam_client</span><span class=o>.</span><span class=n>attach_role_policy</span><span class=p>(</span>
	<span class=n>RoleName</span><span class=o>=</span><span class=n>role_name</span><span class=p>,</span>
	<span class=n>PolicyArn</span><span class=o>=</span><span class=n>create_policy_response</span><span class=p>[</span><span class=s1>&#39;Policy&#39;</span><span class=p>][</span><span class=s1>&#39;Arn&#39;</span><span class=p>]</span>
<span class=p>)</span>
</code></pre></div><p><strong>After saving the code in a file called create_jitr_lambda.py, you can execute by running the following command:</strong></p><pre><code>python create_jitr_lambda.py
</code></pre><h5 id=creating-lambda-function>Creating Lambda function</h5><p>The lambda function will then be created with the following script. The code for the lambda function will be in a zipped file named <strong>jitr_lambda.zip</strong>. Download the lambda code <a href=https://github.com/awslabs/aws-iot-examples/blob/master/justInTimeRegistration/deviceActivation.js>here</a> <strong>and make sure to modify the region-name in the code to your approrpiate region</strong>.</p><p>Next, zip up the code in a file called <strong>jitr_lambda.zip</strong> and keep it in the same directory as the following python script.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=c1>#Download the zip file with the lambda code and save it in the same directory as this script.</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;jitr_lambda.zip&#39;</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s1>&#39;rb&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=nb>file</span><span class=p>:</span>   
	<span class=n>filecontent</span> <span class=o>=</span> <span class=nb>file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>

<span class=n>lambda_client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;lambda&#39;</span><span class=p>)</span>
<span class=n>create_lambda_response</span> <span class=o>=</span> <span class=n>lambda_client</span><span class=o>.</span><span class=n>create_function</span><span class=p>(</span>
	<span class=n>FunctionName</span><span class=o>=</span><span class=s1>&#39;jitr-lambda&#39;</span><span class=p>,</span>
	<span class=n>Runtime</span><span class=o>=</span><span class=s1>&#39;nodejs4.3&#39;</span><span class=p>,</span>
	<span class=c1>#By appending this script unto create_jitr_lambda.py you do not need to find the role_ARN, as it will already be stored in this object.</span>
	<span class=n>Role</span><span class=o>=</span><span class=n>attach_response</span><span class=p>[</span><span class=s1>&#39;Arn&#39;</span><span class=p>]</span>
	<span class=n>Handler</span><span class=o>=</span><span class=s1>&#39;index.handler	&#39;</span><span class=p>,</span>
	<span class=n>Code</span><span class=o>=</span><span class=p>{</span>
		<span class=s1>&#39;ZipFile&#39;</span><span class=p>:</span> <span class=n>filecontent</span>
	<span class=p>},</span>
	<span class=n>Description</span><span class=o>=</span><span class=s1>&#39;Lambda function for Just-in-time-Registration&#39;</span><span class=p>,</span>
<span class=p>)</span>	
</code></pre></div><p><strong>Note that this script requires the Role ARN for the IAM role you just created. If you append this script to the file create_jitr_lambda.py, it will already be included in the response from attaching the policy to the jitr_role, and you won&rsquo;t have to do anything.</strong></p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=c1>#Do not copy and run these lines, this is just showing where the role_ARN was taken from</span>
<span class=n>attach_response</span> <span class=o>=</span> <span class=n>iam_client</span><span class=o>.</span><span class=n>attach_role_policy</span><span class=p>(</span>
	<span class=n>RoleName</span><span class=o>=</span><span class=n>role_name</span><span class=p>,</span>
	<span class=n>PolicyArn</span><span class=o>=</span><span class=n>create_policy_response</span><span class=p>[</span><span class=s1>&#39;Policy&#39;</span><span class=p>][</span><span class=s1>&#39;Arn&#39;</span><span class=p>]</span>
<span class=p>)</span>
<span class=n>role_ARN</span> <span class=o>=</span> <span class=n>attach_response</span><span class=p>[</span><span class=s1>&#39;Arn&#39;</span><span class=p>]</span>
</code></pre></div><p><strong>Otherwise, if you don&rsquo;t wish to append the following script to the create_jitr_lambda.py, here is how you can find the appropriate role_arn</strong>:</p><ol><li>From your <strong>AWS Console</strong> choose the <strong>IAM service</strong>.</li><li>On the <strong>left hand bar</strong>, click on <strong>Roles</strong></li><li>Select the role titled <strong>jitr_role</strong>.</li><li>Copy the section following <strong>Role ARN</strong></li><li>In the following python script, replace: <strong>Role=attach_resopnse[&lsquo;Arn&rsquo;]</strong> with <strong>Role=the_correct_role_arn</strong></li></ol><p>Save the script in an appropriate location, and run it.</p></details></details><hr><h2 id=creating-the-aws-iot-rule>Creating the AWS IoT Rule</h2><p>Finally we will be setting up an AWS IoT Rule to forward all requests with an unregistered certificate to the lambda function that will activate the certificate.</p><p>First we need our caCertificateID</p><ol><li>Under <strong>Secure</strong> click <strong>CAs</strong>.</li><li>Click on the CA Certificate you created earlier.</li><li>Under the CA Certificate ARN, copy the last section of characters possesing your CA Certificate ID.</li></ol><pre><code>arn:aws:iot:us-east-2:302973482904:cacert/&lt;caCertificateID&gt;
</code></pre><p>Now to create the rule</p><ol><li>From your <strong>AWS Console</strong>, click on the <strong>AWS IoT</strong> service.</li><li>On the left hand side, select <strong>Act</strong> and then click <strong>Rules</strong>.</li><li>Click <strong>Create</strong> then give an appropriate Name and Description.</li><li>Using <strong>SQL version 2016-03-23</strong> use the following Rule query statement:</li></ol><pre><code>SELECT * FROM '$aws/events/certificates/registered/&lt;caCertificateID&gt;' 
</code></pre><ol start=5><li>Click <strong>Add action</strong>.</li><li>Click <strong>Send a message to a Lambda function</strong> and <strong>Configure Action</strong>.</li><li>Select your lambda function and click <strong>Add action</strong>.</li><li>Finally click <strong>Create rule</strong>.</li></ol><hr><h2 id=testing-jitr-with-tls-connection>Testing JITR with TLS Connection</h2><p>You can now test your JITR setup by doing a TLS connection with your AWS IoT endpoint and presenting your Zymkey device certificate.</p><details><summary>Details</summary><br><p><strong>The first thing to do is to look for your AWS endpoint.</strong></p><ol><li><p>From the <strong>AWS IoT console screen</strong>, click on the gear that says <strong>Settings</strong> on the left hand bar.</p></li><li><p>Copy the link in the <strong>Custom Endpoint</strong> box.</p></li><li><p>Now on the <strong>left hand bar</strong>, click on the <strong>Test</strong> option.</p></li><li><p>Under <strong>Subscribe</strong> and <strong>Subscription Topic</strong>, type in <strong>hello/world</strong>.</p></li><li><p>Test your TLS connection with the following <strong>CURL</strong> command pointing to your <strong>CA file</strong> and your <strong>Zymkey certificate</strong>:</p></li><li><p>Use <strong>CURL</strong> to test your TLS connection, <strong>pointing to your CA file</strong>:</p><pre><code> curl --tlsv1.2 --cacert zk_ca.pem --cert zymkey.crt --key nonzymkey.key --engine zymkey_ssl --key-type ENG -v -X POST -d &quot;{ \&quot;hello\&quot;: \&quot;world\&quot;}&quot; &quot;https://endpoint.iot.region.amazonaws.com:8443/topics/hello/world&quot;
</code></pre></li></ol><p>The TLS connection should go through, and you should see something like this in your command line:</p><p><img src=../jitr-curl.png alt=curl|690x122></p><p>On first connection TLS connection, the TLS handshake should finish, but you should receive empty response from server:</p><p><img src=../jitr-empty.png alt=response_empty></p><p>On second TLS connection, you will see that the certifiacte is registered and you will get a correct response:</p><p><img src=../jitr-forbidden.png alt=response_forbidden></p><p>You can also check under your certifiactes in your AWS IoT console to see that the new certifciacte is indeed registered. Getting a non-empty response indicates that the certificate is indeed registerd on you AWS account. However, even though the certificate is activated, it does not have a valid policy granting it permission to publish data to your AWS IoT account, which results in the <strong>forbidden</strong> response. Fortunately you can always <strong>modify the jitr lambda function</strong> to attach an <strong>appropriate policy to the certificate upon registration/activation</strong> if you wish to do so.</p></details><div class="text-muted mt-5 pt-3 border-top"></div></div></main></div></div><footer class="bg-dark py-5 row d-print-none"><div class="container-fluid mx-sm-5"><div class=row><div class="col-6 col-sm-4 text-xs-center order-sm-2"></div><div class="col-6 col-sm-4 text-right text-xs-center order-sm-3"></div><div class="col-12 col-sm-4 text-center py-2 order-sm-2"></div></div></div></footer></div><script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script><script src=/js/main.min.2ba2da7d2fe4be755f96e1f7760bcc4a769c4b9369d2356a8872050735635419.js integrity="sha256-K6LafS/kvnVfluH3dgvMSnacS5Np0jVqiHIFBzVjVBk=" crossorigin=anonymous></script></body></html>