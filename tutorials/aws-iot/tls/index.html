<!doctype html><html lang=en class=no-js>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=generator content="Hugo 0.90.1"><meta name=ROBOTS content="INDEX, FOLLOW">
<link rel="shortcut icon" href=/favicons/favicon.ico>
<link rel=apple-touch-icon href=/favicons/apple-touch-icon.png sizes=180x180>
<link rel=icon type=image/png href=/favicons/favicon-16x16.png sizes=16x16>
<link rel=icon type=image/png href=/favicons/favicon-32x32.png sizes=32x32>
<link rel=icon type=image/png href=/favicons/android-chrome-192x192.png sizes=192x192>
<link rel=icon type=image/png href=/favicons/android-chrome-512x512.png sizes=512x512>
<title>AWS IoT - TLS Client Certificate Authentication | </title>
<meta name=description content="How to generate a client certificate for your Zymkey, register your own CA, and establish a TLS connection to AWS IoT to publish data.

Overview

The â€¦">
<meta property="og:title" content="AWS IoT - TLS Client Certificate Authentication">
<meta property="og:description" content="How to generate a client certificate for your Zymkey, register your own CA, and establish a TLS connection to AWS IoT to publish data.  Overview The following post will show you how to create and register a Zymkey Client Certificate for devices connecting to AWS IoT, as well as how to publish data to AWS IoT using Zymkey. This will allow you to connect a client device to AWS IoT using the private key stored in a Zymkey hardware security module, which is inherently a more secure client certification and authentication method.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://docs.zymbit.com/tutorials/aws-iot/tls/"><meta property="og:image" content="https://docs.zymbit.com/doks.png"><meta property="article:section" content="tutorials">
<meta property="article:modified_time" content="2021-11-07T14:19:14-08:00"><meta property="og:site_name" content="Zymbit Documentation">
<meta itemprop=name content="AWS IoT - TLS Client Certificate Authentication">
<meta itemprop=description content="How to generate a client certificate for your Zymkey, register your own CA, and establish a TLS connection to AWS IoT to publish data.  Overview The following post will show you how to create and register a Zymkey Client Certificate for devices connecting to AWS IoT, as well as how to publish data to AWS IoT using Zymkey. This will allow you to connect a client device to AWS IoT using the private key stored in a Zymkey hardware security module, which is inherently a more secure client certification and authentication method.">
<meta itemprop=dateModified content="2021-11-07T14:19:14-08:00">
<meta itemprop=wordCount content="2587"><meta itemprop=image content="https://docs.zymbit.com/doks.png">
<meta itemprop=keywords content><meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://docs.zymbit.com/doks.png">
<meta name=twitter:title content="AWS IoT - TLS Client Certificate Authentication">
<meta name=twitter:description content="How to generate a client certificate for your Zymkey, register your own CA, and establish a TLS connection to AWS IoT to publish data.  Overview The following post will show you how to create and register a Zymkey Client Certificate for devices connecting to AWS IoT, as well as how to publish data to AWS IoT using Zymkey. This will allow you to connect a client device to AWS IoT using the private key stored in a Zymkey hardware security module, which is inherently a more secure client certification and authentication method.">
<link rel=preload href=/scss/main.min.874b26b473cb7a1e419be33bf4a26faf0fd5ae3733989c5d2c9ab928a11b409d.css as=style>
<link href=/scss/main.min.874b26b473cb7a1e419be33bf4a26faf0fd5ae3733989c5d2c9ab928a11b409d.css rel=stylesheet integrity>
<script src=https://code.jquery.com/jquery-3.5.1.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
</head>
<body class=td-page>
<header>
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
<a class=navbar-brand href=/>
<img class=navbar-logo src=https://docs.zymbit.com/Zymbit-Logo.gif>
</a>
<div class="td-navbar-nav-scroll ml-md-auto" id=main_navbar>
<ul class="navbar-nav mt-2 mt-lg-0">
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://community.zymbit.com/ target=_blank><i class="fab fa-discourse"></i><span>Community</span></a>
</li>
<li class="nav-item mr-4 mb-2 mb-lg-0">
<a class=nav-link href=https://github.com/zymbit-docs target=_blank><i class="fab fa-github"></i><span>GitHub</span></a>
</li>
</ul>
</div>
<div class="navbar-nav d-none d-lg-block"></div>
</nav>
</header>
<div class="container-fluid td-outer">
<div class=td-main>
<div class="row flex-xl-nowrap">
<aside class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
<div id=td-sidebar-menu class=td-sidebar__inner>
<form class="td-sidebar__search d-flex align-items-center">
<button class="btn btn-link td-sidebar__toggle d-md-none p-0 ml-3 fas fa-bars" type=button data-toggle=collapse data-target=#td-section-nav aria-controls=td-docs-nav aria-expanded=false aria-label="Toggle section navigation">
</button>
</form>
<nav class="collapse td-sidebar-nav foldable-nav" id=td-section-nav>
<ul class="td-sidebar-nav__section pr-md-3 ul-0 fa-ul">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m--li>
<a href=/ class="align-left pl-0 pr-2 td-sidebar-link td-sidebar-link__section tree-root" id=m-><span class=fa-li><i class=nav-open-tree></i></span><span>Zymbit Documentation</span></a>
<ul class="pr-md-3 ul-1">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-getting-started-li>
<input type=checkbox id=m-getting-started-check checked>
<label for=m-getting-started-check><a href=/getting-started/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-getting-started><span class=td-sidebar-link__section>Getting Started</span></a></label>
<ul class="pr-md-3 ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-getting-startedzymkey4-li>
<input type=checkbox id=m-getting-startedzymkey4-check>
<label for=m-getting-startedzymkey4-check><span class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-getting-startedzymkey4><span class=td-sidebar-link__section>ZYMKEY4</span></span></label>
<ul class="pr-md-3 ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-startedzymkey4quickstart-li>
<input type=checkbox id=m-getting-startedzymkey4quickstart-check>
<label for=m-getting-startedzymkey4quickstart-check><a href=/getting-started/zymkey4/quickstart/ title="Zymkey4 Quickstart" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-getting-startedzymkey4quickstart><span class=td-sidebar-link__page>Quickstart</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-startedzymkey4production-mode-li>
<input type=checkbox id=m-getting-startedzymkey4production-mode-check>
<label for=m-getting-startedzymkey4production-mode-check><a href=/getting-started/zymkey4/production-mode/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-getting-startedzymkey4production-mode><span class=td-sidebar-link__page>Enabling Production Mode</span></a></label>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-getting-startedhsm4-li>
<input type=checkbox id=m-getting-startedhsm4-check>
<label for=m-getting-startedhsm4-check><span class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-getting-startedhsm4><span class=td-sidebar-link__section>HSM4</span></span></label>
<ul class="pr-md-3 ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-startedhsm4quickstart-li>
<input type=checkbox id=m-getting-startedhsm4quickstart-check>
<label for=m-getting-startedhsm4quickstart-check><a href=/getting-started/hsm4/quickstart/ title="Getting Started with HSM4" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-getting-startedhsm4quickstart><span class=td-sidebar-link__page>Quickstart</span></a></label>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-getting-startedhsm6-li>
<input type=checkbox id=m-getting-startedhsm6-check>
<label for=m-getting-startedhsm6-check><span class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-getting-startedhsm6><span class=td-sidebar-link__section>HSM6</span></span></label>
<ul class="pr-md-3 ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-getting-startedhsm6quickstart-li>
<input type=checkbox id=m-getting-startedhsm6quickstart-check>
<label for=m-getting-startedhsm6quickstart-check><a href=/getting-started/hsm6/quickstart/ title="Getting Started with HSM6" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-getting-startedhsm6quickstart><span class=td-sidebar-link__page>Quickstart</span></a></label>
</li>
</ul>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-api-li>
<input type=checkbox id=m-api-check checked>
<label for=m-api-check><a href=/api/ title="API Documentation" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-api><span class=td-sidebar-link__section>API</span></a></label>
<ul class="pr-md-3 ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-apic_api-li>
<input type=checkbox id=m-apic_api-check>
<label for=m-apic_api-check><a href=/api/c_api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-apic_api><span class=td-sidebar-link__page>C API Documentation</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-apicpp_api-li>
<input type=checkbox id=m-apicpp_api-check>
<label for=m-apicpp_api-check><a href=/api/cpp_api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-apicpp_api><span class=td-sidebar-link__page>C++ API Documentation</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-apipython_api-li>
<input type=checkbox id=m-apipython_api-check>
<label for=m-apipython_api-check><a href=/api/python_api/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-apipython_api><span class=td-sidebar-link__page>Python API Documentation</span></a></label>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-troubleshooting-li>
<input type=checkbox id=m-troubleshooting-check checked>
<label for=m-troubleshooting-check><a href=/troubleshooting/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-troubleshooting><span class=td-sidebar-link__section>FAQ and Troubleshooting</span></a></label>
<ul class="pr-md-3 ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-troubleshootinggeneral-li>
<input type=checkbox id=m-troubleshootinggeneral-check>
<label for=m-troubleshootinggeneral-check><a href=/troubleshooting/general/ title="General FAQ & Troubleshooting" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-troubleshootinggeneral><span class=td-sidebar-link__page>General</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-troubleshootingzymkey4-li>
<input type=checkbox id=m-troubleshootingzymkey4-check>
<label for=m-troubleshootingzymkey4-check><a href=/troubleshooting/zymkey4/ title="ZYMKEY4 FAQ & Troubleshooting" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-troubleshootingzymkey4><span class=td-sidebar-link__page>ZYMKEY4</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-troubleshootinghsm4-li>
<input type=checkbox id=m-troubleshootinghsm4-check>
<label for=m-troubleshootinghsm4-check><a href=/troubleshooting/hsm4/ title="HSM4 FAQ & Troubleshooting" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-troubleshootinghsm4><span class=td-sidebar-link__page>HSM4</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-troubleshootinghsm6-li>
<input type=checkbox id=m-troubleshootinghsm6-check>
<label for=m-troubleshootinghsm6-check><a href=/troubleshooting/hsm6/ title="HSM6 FAQ & Troubleshooting" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-troubleshootinghsm6><span class=td-sidebar-link__page>HSM6</span></a></label>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-reference-li>
<input type=checkbox id=m-reference-check checked>
<label for=m-reference-check><a href=/reference/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-reference><span class=td-sidebar-link__section>Reference</span></a></label>
<ul class="pr-md-3 ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referenceproduct-briefs-li>
<input type=checkbox id=m-referenceproduct-briefs-check>
<label for=m-referenceproduct-briefs-check><a href=/reference/product-briefs/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-referenceproduct-briefs><span class=td-sidebar-link__section>Product Briefs</span></a></label>
<ul class="pr-md-3 ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceproduct-briefszymkey4-li>
<input type=checkbox id=m-referenceproduct-briefszymkey4-check>
<label for=m-referenceproduct-briefszymkey4-check><a href=https://www.zymbit.com/datasheets/zymkey-4i title target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referenceproduct-briefszymkey4><span class=td-sidebar-link__page>ZYMKEY4</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceproduct-briefshsm4-li>
<input type=checkbox id=m-referenceproduct-briefshsm4-check>
<label for=m-referenceproduct-briefshsm4-check><a href=https://www.zymbit.com/datasheets/hsm4 title target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referenceproduct-briefshsm4><span class=td-sidebar-link__page>HSM4</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceproduct-briefshsm6-li>
<input type=checkbox id=m-referenceproduct-briefshsm6-check>
<label for=m-referenceproduct-briefshsm6-check><a href=https://www.zymbit.com/datasheets/hsm6 title target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referenceproduct-briefshsm6><span class=td-sidebar-link__page>HSM6</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceproduct-briefsmfg-app-li>
<input type=checkbox id=m-referenceproduct-briefsmfg-app-check>
<label for=m-referenceproduct-briefsmfg-app-check><a href=https://www.zymbit.com/datasheets/manufacturing-appliance-1 title target=_blank rel=noopener class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referenceproduct-briefsmfg-app><span class=td-sidebar-link__page>Manufacturing Appliance</span></a></label>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referencecad-li>
<input type=checkbox id=m-referencecad-check>
<label for=m-referencecad-check><a href=/reference/cad/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-referencecad><span class=td-sidebar-link__section>CAD Files</span></a></label>
<ul class="pr-md-3 ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencecadzymkey4-li>
<input type=checkbox id=m-referencecadzymkey4-check>
<label for=m-referencecadzymkey4-check><a href=/reference/cad/zymkey4/ title="Zymkey4 CAD Files" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referencecadzymkey4><span class=td-sidebar-link__page>ZYMKEY4</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencecadhsm4-li>
<input type=checkbox id=m-referencecadhsm4-check>
<label for=m-referencecadhsm4-check><a href=/reference/cad/hsm4/ title="HSM4 CAD Files" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referencecadhsm4><span class=td-sidebar-link__page>HSM4</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencecadhsm6-li>
<input type=checkbox id=m-referencecadhsm6-check>
<label for=m-referencecadhsm6-check><a href=/reference/cad/hsm6/ title="HSM6 CAD Files" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referencecadhsm6><span class=td-sidebar-link__page>HSM6</span></a></label>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-referenceconformity-li>
<input type=checkbox id=m-referenceconformity-check>
<label for=m-referenceconformity-check><a href=/reference/conformity/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-referenceconformity><span class=td-sidebar-link__section>Conformity Documents</span></a></label>
<ul class="pr-md-3 ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceconformityzymkey4-li>
<input type=checkbox id=m-referenceconformityzymkey4-check>
<label for=m-referenceconformityzymkey4-check><a href=/reference/conformity/zymkey4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referenceconformityzymkey4><span class=td-sidebar-link__page>Zymkey4 Conformity Documents</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceconformityhsm4-li>
<input type=checkbox id=m-referenceconformityhsm4-check>
<label for=m-referenceconformityhsm4-check><a href=/reference/conformity/hsm4/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referenceconformityhsm4><span class=td-sidebar-link__page>HSM4 Conformity Documents</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referenceconformityhsm6-li>
<input type=checkbox id=m-referenceconformityhsm6-check>
<label for=m-referenceconformityhsm6-check><a href=/reference/conformity/hsm6/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referenceconformityhsm6><span class=td-sidebar-link__page>HSM6 Conformity Documents</span></a></label>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencepower-quality-li>
<input type=checkbox id=m-referencepower-quality-check>
<label for=m-referencepower-quality-check><a href=/reference/power-quality/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referencepower-quality><span class=td-sidebar-link__page>Power Quality Considerations</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencebinding-li>
<input type=checkbox id=m-referencebinding-check>
<label for=m-referencebinding-check><a href=/reference/binding/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referencebinding><span class=td-sidebar-link__page>Binding, Device ID, and Authentication</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencecpu-scaling-li>
<input type=checkbox id=m-referencecpu-scaling-check>
<label for=m-referencecpu-scaling-check><a href=/reference/cpu-scaling/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referencecpu-scaling><span class=td-sidebar-link__page>CPU Scaling Governor</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-referencereal-time-clock-li>
<input type=checkbox id=m-referencereal-time-clock-check>
<label for=m-referencereal-time-clock-check><a href=/reference/real-time-clock/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-referencereal-time-clock><span class=td-sidebar-link__page>Real Time Clock Operation</span></a></label>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-tutorials-li>
<input type=checkbox id=m-tutorials-check checked>
<label for=m-tutorials-check><a href=/tutorials/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-tutorials><span class=td-sidebar-link__section>Tutorials</span></a></label>
<ul class="pr-md-3 ul-2 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsalternative-gpio-li>
<input type=checkbox id=m-tutorialsalternative-gpio-check>
<label for=m-tutorialsalternative-gpio-check><a href=/tutorials/alternative-gpio/ title="Using an Alternative GPIO Pin" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsalternative-gpio><span class=td-sidebar-link__page>Alternative GPIO Pin</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsdigital-wallet-li>
<input type=checkbox id=m-tutorialsdigital-wallet-check>
<label for=m-tutorialsdigital-wallet-check><a href=/tutorials/digital-wallet/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsdigital-wallet><span class=td-sidebar-link__page>Digital Wallet</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsencrypt-rfs-li>
<input type=checkbox id=m-tutorialsencrypt-rfs-check>
<label for=m-tutorialsencrypt-rfs-check><a href=/tutorials/encrypt-rfs/ title="Encrypting Root File System with Zymbit Security Modules" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsencrypt-rfs><span class=td-sidebar-link__page>Encrypt Root File System</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialssensor-data-li>
<input type=checkbox id=m-tutorialssensor-data-check>
<label for=m-tutorialssensor-data-check><a href=/tutorials/sensor-data/ title="Encrypting & Decrypting Sensor Data on Disk" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialssensor-data><span class=td-sidebar-link__page>Encrypt Sensor Data</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child active-path" id=m-tutorialsaws-iot-li>
<input type=checkbox id=m-tutorialsaws-iot-check checked>
<label for=m-tutorialsaws-iot-check><a href=/tutorials/aws-iot/ title="AWS IoT Integrations & Client Certificates" class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-tutorialsaws-iot><span class=td-sidebar-link__section>Integrate Zymbit with AWS</span></a></label>
<ul class="pr-md-3 ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsaws-iotintegrate-li>
<input type=checkbox id=m-tutorialsaws-iotintegrate-check>
<label for=m-tutorialsaws-iotintegrate-check><a href=/tutorials/aws-iot/integrate/ title="How to Integrate Zymbit with AWS Credentials Provider" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsaws-iotintegrate><span class=td-sidebar-link__page>Integrate with AWS Credentials Provider</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsaws-iotjitr-li>
<input type=checkbox id=m-tutorialsaws-iotjitr-check>
<label for=m-tutorialsaws-iotjitr-check><a href=/tutorials/aws-iot/jitr/ title="AWS IoT - Just in Time Registration of Client Certificates using Lambda functions" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsaws-iotjitr><span class=td-sidebar-link__page>Just In Time Registration</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child active-path" id=m-tutorialsaws-iottls-li>
<input type=checkbox id=m-tutorialsaws-iottls-check checked>
<label for=m-tutorialsaws-iottls-check><a href=/tutorials/aws-iot/tls/ title="AWS IoT - TLS Client Certificate Authentication" class="align-left pl-0 active td-sidebar-link td-sidebar-link__page" id=m-tutorialsaws-iottls><span class="td-sidebar-nav-active-item td-sidebar-link__page">Transport Level Security</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsaws-iotverify-sigs-li>
<input type=checkbox id=m-tutorialsaws-iotverify-sigs-check>
<label for=m-tutorialsaws-iotverify-sigs-check><a href=/tutorials/aws-iot/verify-sigs/ title="How to Verify Signatures against Public Key on AWS and Other Devices" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsaws-iotverify-sigs><span class=td-sidebar-link__page>Verify Signatures</span></a></label>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section with-child" id=m-tutorialsperimeter-detect-li>
<input type=checkbox id=m-tutorialsperimeter-detect-check>
<label for=m-tutorialsperimeter-detect-check><a href=/tutorials/perimeter-detect/ class="align-left pl-0 td-sidebar-link td-sidebar-link__section" id=m-tutorialsperimeter-detect><span class=td-sidebar-link__section>Perimeter Detect</span></a></label>
<ul class="pr-md-3 ul-3 foldable">
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsperimeter-detectzymkey4-li>
<input type=checkbox id=m-tutorialsperimeter-detectzymkey4-check>
<label for=m-tutorialsperimeter-detectzymkey4-check><a href=/tutorials/perimeter-detect/zymkey4/ title="Perimeter Detect: ZYMKEY4" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsperimeter-detectzymkey4><span class=td-sidebar-link__page>ZYMKEY4</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsperimeter-detecthsm4-li>
<input type=checkbox id=m-tutorialsperimeter-detecthsm4-check>
<label for=m-tutorialsperimeter-detecthsm4-check><a href=/tutorials/perimeter-detect/hsm4/ title="Perimeter Detect: HSM4" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsperimeter-detecthsm4><span class=td-sidebar-link__page>HSM4</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsperimeter-detecthsm6-li>
<input type=checkbox id=m-tutorialsperimeter-detecthsm6-check>
<label for=m-tutorialsperimeter-detecthsm6-check><a href=/tutorials/perimeter-detect/hsm6/ title="Perimeter Detect: HSM6" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsperimeter-detecthsm6><span class=td-sidebar-link__page>HSM6</span></a></label>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsperimeter-detectexamples-li>
<input type=checkbox id=m-tutorialsperimeter-detectexamples-check>
<label for=m-tutorialsperimeter-detectexamples-check><a href=/tutorials/perimeter-detect/examples/ title="Perimeter Detect Circuit Examples" class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsperimeter-detectexamples><span class=td-sidebar-link__page>CIRCUIT EXAMPLES</span></a></label>
</li>
</ul>
</li>
<li class="td-sidebar-nav__section-title td-sidebar-nav__section without-child" id=m-tutorialsprotokit-li>
<input type=checkbox id=m-tutorialsprotokit-check>
<label for=m-tutorialsprotokit-check><a href=/tutorials/protokit/ class="align-left pl-0 td-sidebar-link td-sidebar-link__page" id=m-tutorialsprotokit><span class=td-sidebar-link__page>ProtoKit5</span></a></label>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</div>
</aside><aside class="d-none d-xl-block col-xl-2 td-sidebar-toc d-print-none">
<div class="td-page-meta ml-2 pb-1 pt-2 mb-0">
</div>
<div class=td-toc><nav id=TableOfContents>
<ul>
<li>
<ul>
<li>
<ul>
<li></li>
</ul>
</li>
</ul>
</li>
<li><a href=#overview>Overview</a></li>
<li><a href=#prerequisites>Prerequisites</a></li>
<li><a href=#process-overview>Process Overview</a></li>
<li><a href=#manual-vs-programmatic-setup>Manual vs. Programmatic Setup</a></li>
<li><a href=#creating-a-certificate-signing-request-with-zymkey>Creating a Certificate Signing Request with Zymkey</a></li>
<li><a href=#registering-a-certificate-authority>Registering a Certificate Authority</a>
<ul>
<li><a href=#option-a---using-the-aws-iot-root-certificate-authority-easiest>Option A - Using the AWS IoT Root Certificate Authority (Easiest)</a>
<ul>
<li><a href=#signing-csr-with-aws-certificate-authority>Signing CSR with AWS' Certificate Authority</a></li>
</ul>
</li>
<li><a href=#option-b---using-your-own-certificate-authority>Option B - Using your own Certificate Authority</a>
<ul>
<li><a href=#creating-an-example-ca-with-openssl>Creating an example CA with OpenSSL</a></li>
<li><a href=#signing-csr-with-certificate-authority>Signing CSR with Certificate Authority</a></li>
<li><a href=#registering-certificate-authority-with-aws>Registering Certificate Authority with AWS</a></li>
</ul>
</li>
</ul>
</li>
<li><a href=#registering-a-device-certificate-signed-by-certificate-authority>Registering a Device Certificate signed by Certificate Authority</a></li>
<li><a href=#testing-tls-connection-with-zymkey-device-certificate>Testing TLS connection with Zymkey Device Certificate:</a></li>
<li><a href=#attaching-policy-to-certificate-and-publishing-to-aws-iot>Attaching Policy to Certificate and Publishing to AWS IoT</a></li>
<li><a href=#publishing-data-to-aws-iot>Publishing data to AWS IoT</a></li>
</ul>
</nav></div>
</aside><main class="col-12 col-md-8 col-xl-7 pl-md-5" role=main>
<nav aria-label=breadcrumb class="d-none d-md-block d-print-none">
<ol class="breadcrumb spb-1">
<li class=breadcrumb-item>
<a href=https://docs.zymbit.com/tutorials/>Tutorials</a>
</li>
<li class=breadcrumb-item>
<a href=https://docs.zymbit.com/tutorials/aws-iot/>Integrate Zymbit with AWS</a>
</li>
<li class="breadcrumb-item active" aria-current=page>
<a href=https://docs.zymbit.com/tutorials/aws-iot/tls/>Transport Level Security</a>
</li>
</ol>
</nav>
<div class=td-content>
<h1>AWS IoT - TLS Client Certificate Authentication</h1>
<header class=article-meta>
</header>
<h5 id=how-to-generate-a-client-certificate-for-your-zymkey-register-your-own-ca-and-establish-a-tls-connection-to-aws-iot-to-publish-data>How to generate a client certificate for your Zymkey, register your own CA, and establish a TLS connection to AWS IoT to publish data.</h5>
<hr>
<h2 id=overview>Overview</h2>
<p><img src=aws-iot-tls.png alt=AWS-IoT-BYOC-graphic-2></p>
<p>The following post will show you how to create and register a Zymkey Client Certificate for devices connecting to AWS IoT, as well as how to publish data to AWS IoT using Zymkey. This will allow you to connect a client device to AWS IoT using the private key stored in a Zymkey hardware security module, which is inherently a more secure client certification and authentication method.</p>
<p><em>If you have a large number of client devices to connect to AWS IoT, consider using the more automated Just In Time Registration Process using Zymkey. <a href=https://docs.zymbit.com/tutorials/aws-iot/jitr/>More details.</a></em></p>
<hr>
<p>AWS IoT uses a certificate based system for its TLS client authentication. This means that any attempted connection to the AWS IoT servers such as when pulling/publishing data, which is done through TLS/HTTPS, requires the client to present a valid client certificate as well as a valid certificate authority certificate. Furthermore the client must be able to prove that they have the private key associated with the provided certificate. Client Certificates are considered valid if they are registered with Amazon.</p>
<p>In this example we will be using <em>AWS IoT&rsquo;s BYOC (Bring Your Own Certicate)</em> system to create a certificate based on Zymkey&rsquo;s private key and register it with Amazon. The Zymkey certificate can be signed by either the AWS IoT root certificate authority or your own certificate authority. Both methods will be covered here. Once the setup is complete, you will be able to work with AWS IoT using their REST API, authenticating with Zymkey&rsquo;s private key.</p>
<p>Classic client TLS authentication requires the user to keep their private key stored in a file, such as in a file called <code>zymkey.key</code>, and the key is read by whatever client is establishing the TLS connection so that it can be used to prove that you own the key.</p>
<p>With Zymkey, authentication is done by a key that cannot be read/exported and that isn&rsquo;t kept on the file system. The key is always stored in the Zymkey hardware.</p>
<p>Lastly, we will show you how to test your setup. This is done with CURL to make HTTPS requests to the MQTT port 8443. A future post will show how communicate with AWS IoT through their <a href=http://docs.aws.amazon.com/iot/latest/apireference/Welcome.html>REST API</a> and authenticating with Zymkey&rsquo;s private key in Python.</p>
<hr>
<h2 id=prerequisites>Prerequisites</h2>
<p>Install the necessary software packages and insure the Zymkey is bound to its host using the <a href=https://docs.zymbit.com/getting-started/>Getting Started Guide</a>.</p>
<p>Have a registered AWS Account, a free developer account can be made <a href=https://aws.amazon.com/free/>here</a>.</p>
<hr>
<h2 id=process-overview>Process Overview</h2>
<ol>
<li>Create a Certificate Signing Request (CSR) with Zymkey private key</li>
<li>Sign CSR with a Certificate Authority to get a Zymkey Device Certificate</li>
<li>If using your own Certificate Authority, register it with AWS</li>
<li>Register the Zymkey Device Certificate with AWS</li>
<li>Test a TLS connection using your Zymkey Device Certificate and Private Key</li>
<li>Attach a policy to the Zymkey Device Certificate to allow it to publish data to AWS IoT</li>
<li>Publish data to AWS IoT over TLS using Zymkey Device Certificate for authentication</li>
</ol>
<hr>
<h2 id=manual-vs-programmatic-setup>Manual vs. Programmatic Setup</h2>
<details>
<summary>Details</summary>
<br>
<p>All AWS settings can be configured either manually through the AWS web interface or programatically through <a href=https://boto3.readthedocs.io/en/latest/reference/services/iot.html>AWS' boto 3 module</a> in Python. If you would like to use scripts to programatically set up your client certificate, you will need to do the following steps.</p>
<p>First, follow these instructions on the boto3 page to set up the boto3 module for Python:
http://boto3.readthedocs.io/en/latest/guide/quickstart.html</p>
<p>The boto3 module authenticates with AWS based on a IAM Access ID and Secret Key. The boto3 tutorial will ask you to setup an IAM user, here are some instructions on how to do so:</p>
<ol>
<li>From the <strong>AWS console</strong>, choose the <strong>IAM service</strong>.</li>
<li>Go to <strong>Users</strong> and select <strong>Add User</strong></li>
<li>Choose a <strong>username</strong> and check the <strong>Programmatic access box</strong></li>
<li>For simplicity, choose <strong>Attach existing policies directly</strong> and select <strong>AdministratorAccess</strong></li>
<li>If you wish to better manage your IAM credentials, feel free to customize your Access Policy.</li>
<li>Click <strong>Review</strong> and then <strong>Create User</strong></li>
<li><strong>Save the Access ID and Secret Key</strong> and <strong>follow the boto3 guide</strong>.</li>
</ol>
</details>
<hr>
<h2 id=creating-a-certificate-signing-request-with-zymkey>Creating a Certificate Signing Request with Zymkey</h2>
<p><strong>B</strong>ring <strong>Y</strong>our <strong>O</strong>wn device <strong>C</strong>ertificate (BYOC)</p>
<p>The first step is to create a valid device certificate using Zymkey&rsquo;s private key. This means that it needs to be signed by a valid Certificate Authority; this can be done by first creating a Certificate Signing Request using OpenSSL:</p>
<pre><code>openssl req -key nonzymkey.key -new -out zymkey.csr -engine zymkey_ssl -keyform e -subj &quot;/C=US/ST=California/L=Santa Barbara/O=Zymbit/OU=Zymkey/CN=rpi.edge.zymbit.com&quot;
</code></pre>
<p>The file <code>nonzymkey.key</code> is a placeholder argument and is not actually a real file or used since Zymkey&rsquo;s private key can not be exported nor read. A CSR file <code>zymkey.csr</code> is created in the directory where this command is run. The <strong>-subj</strong> argument automatically inserts certificate information, but you can leave this argument out and will be prompted to input your own information.</p>
<hr>
<h2 id=registering-a-certificate-authority>Registering a Certificate Authority</h2>
<p>Now that you have created a CSR with Zymkey, you have two options for Certificate Authorities.</p>
<h3 id=option-a---using-the-aws-iot-root-certificate-authority-easiest>Option A - Using the AWS IoT Root Certificate Authority (Easiest)</h3>
<details>
<summary>Details</summary>
<br>
<h4 id=signing-csr-with-aws-certificate-authority>Signing CSR with AWS' Certificate Authority</h4>
<p>Using AWS' Certificate Authority is the easier option in terms of setup and allows you to use a trustworthy Certificate Authority that Amazon uses its services. The following steps show you how to sign your Zymkey&rsquo;s private key with Amazon&rsquo;s CA and get a valid device certificate:</p>
<hr>
<p><strong>Manually:</strong></p>
<ol>
<li>Sign into your <strong>AWS console</strong>. Here is a link to the console sign-in page: https://aws.amazon.com/console/</li>
<li>From the console, select the <strong>AWS IoT Core</strong> service</li>
<li>Under the <strong>secure</strong> tab, click on <strong>Certificates</strong> and click the blue <strong>Create a certificate</strong> bar</li>
<li>Choose the <strong>Create with CSR</strong> option</li>
<li>When the File Selection menu pops up <strong>point to your CSR file</strong>. It shoud be <code>zymkey.csr</code> by default. Choose <strong>Upload file</strong>. We created this file on your IoT device, you may need to transfer it to where your logged into AWS.</li>
<li><strong>Download the Certificate file</strong> on the next screen and save as <code>zymkey.crt</code>. If you are not logged into AWS from your IoT device, transfer the file to your IoT device. We will use this later.</li>
<li>You also need to download the <strong>root CA for AWS IoT</strong>, by <strong>clicking Download</strong>. On the page that opens, scroll down to the section <strong>CA certificates for server authentication</strong>, click <strong>ECC 256 bit key</strong> and click on the adjacent link <strong>Amazon Root CA 3</strong>. Copy the public key into a file named <code>AWS_CA.pem</code> file. If you are not logged into AWS from your IoT device, transfer <strong>AWS_CA.pem</strong> to your IoT device. We will use this later.</li>
<li>Return to the <strong>Create Certificate</strong> <strong>AWS IoT</strong> page and click <strong>Activate</strong></li>
</ol>
<hr>
<p><strong>Programatically:</strong>
Using the boto3 client, this python script will read the csr file <code>zymkey.csr</code>, give it to AWS to sign with their Certificate Authority, and create a signed certificate <code>zymkey.crt</code> in the directory where this program is run. Furthermore the certificate will be automatically registered and activated with AWS IoT and will be ready for use.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>boto3</span>

<span class=n>iot_client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;iot&#39;</span><span class=p>)</span>
<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;zymkey.csr&#39;</span><span class=p>,</span> <span class=s1>&#39;r&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>zymkey_csr_file</span><span class=p>:</span>
	<span class=n>zymkey_csr</span> <span class=o>=</span> <span class=n>zymkey_csr_file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>

<span class=n>zymkey_cert</span> <span class=o>=</span> <span class=n>iot_client</span><span class=o>.</span><span class=n>create_certificate_from_csr</span><span class=p>(</span>
	<span class=n>certificateSigningRequest</span><span class=o>=</span><span class=n>zymkey_csr</span><span class=p>,</span>
	<span class=n>setAsActive</span><span class=o>=</span><span class=kc>True</span>
<span class=p>)</span>

<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=s1>&#39;zymkey.crt&#39;</span><span class=p>,</span> <span class=s1>&#39;w&#39;</span><span class=p>)</span> <span class=k>as</span> <span class=n>zymkey_cert_file</span><span class=p>:</span>
	<span class=n>zymkey_cert_file</span><span class=o>.</span><span class=n>write</span><span class=p>(</span><span class=n>zymkey_cert</span><span class=p>[</span><span class=s1>&#39;certificatePem&#39;</span><span class=p>])</span>
</code></pre></div><p><strong>Save the above script into a file called aws_sign_csr.py and run with the following command:</strong></p>
<pre><code>python aws_sign_csr.py
</code></pre>
<hr>
<p><strong>Now that your Certificate has been signed and activated by AWS IoT, it can be used to establish a TLS connection with the AWS IoT servers. Skip down to Testing the TLS Connection section to continue.</strong></p>
</details>
<hr>
<h3 id=option-b---using-your-own-certificate-authority>Option B - Using your own Certificate Authority</h3>
<details>
<summary>Details</summary>
<br>
<p>AWS IoT also allows you do you use own Certificate Authority as long as you register it with them. This constitutes proving you own the private key to the CA by signing a verification CSR that includes a registration code.</p>
<p>If you already have a Certificate Authority that you would like to use, you can ignore the next part. Here we create an example Certificate Authority using OpenSSL.</p>
<h4 id=creating-an-example-ca-with-openssl>Creating an example CA with OpenSSL</h4>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span><span class=nb>set</span> -e
mkdir CA_files
<span class=nb>cd</span> CA_files

openssl ecparam -genkey -name prime256v1 -out zk_ca.key
<span class=nv>OPENSSL_CONF</span><span class=o>=</span>/etc/ssl/openssl.cnf openssl req <span class=se>\
</span><span class=se></span>  -x509 -new -SHA256 -nodes -key zk_ca.key <span class=se>\
</span><span class=se></span>  -days <span class=m>3650</span> -out zk_ca.crt <span class=se>\
</span><span class=se></span>  -subj <span class=s2>&#34;/C=US/ST=California/L=Santa Barbara/O=Zymkey/CN=zymkey-verify.zymbit.com.dev&#34;</span>

cp zk_ca.crt zk_ca.pem
</code></pre></div><p>Copy the above lines into a script called <code>mk_ca.sh</code>. You can then run the script in the command line by being in the same directory with the following command:</p>
<pre><code>bash mk_ca.sh
</code></pre>
<p><strong>The script will create a directory called CA_files and a couple of files:</strong>
zk_ca.key: Private key for the created CA, will be supplied to OpenSSL for signing CSRs.
zk_ca.pem: PEM formatted certificate for the CA
zk_ca.crt: Same file as zk_ca.pem</p>
<hr>
<h4 id=signing-csr-with-certificate-authority>Signing CSR with Certificate Authority</h4>
<p>Next we will be signing the Zymkey CSR with your chosen Certificate Authority.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/bin/bash
</span><span class=cp></span><span class=nb>set</span> -e

<span class=nv>SCRIPT_NAME</span><span class=o>=</span><span class=k>$(</span>basename <span class=nv>$0</span><span class=k>)</span>

<span class=o>[</span> -z <span class=nv>$2</span> <span class=o>]</span> <span class=o>&amp;&amp;</span> <span class=nb>echo</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>SCRIPT_NAME</span><span class=si>}</span><span class=s2> &lt;csr filename&gt; &lt;crt filename&gt;&#34;</span> 1&gt;<span class=p>&amp;</span><span class=m>2</span> <span class=o>&amp;&amp;</span> <span class=nb>exit</span> <span class=m>1</span>

<span class=nv>csr</span><span class=o>=</span><span class=nv>$1</span>
<span class=nv>crt</span><span class=o>=</span><span class=nv>$2</span>
openssl x509 -req -SHA256 -days <span class=m>3650</span> <span class=se>\
</span><span class=se></span>  -CA CA_files/zk_ca.crt -CAkey CA_files/zk_ca.key -CAcreateserial <span class=se>\
</span><span class=se></span>  -in <span class=si>${</span><span class=nv>csr</span><span class=si>}</span> -out <span class=si>${</span><span class=nv>crt</span><span class=si>}</span>
</code></pre></div><p>Copy the above lines into a script called <code>sign_csr.sh</code>. The first argument is the relative or absolute path of your csr file, such as <code>zymkey.csr</code> if the file is in the same directory as this script. The second argument is what you want to name the certificate file of the signed cert. Change the -CA and -CAkey file path, can be relative or absolute, if you are using your own CA. You can then run the script in the command line by being in the same directory with the following command:</p>
<pre><code>bash sign_csr.sh zymkey.csr zymkey.crt
</code></pre>
<hr>
<h4 id=registering-certificate-authority-with-aws>Registering Certificate Authority with AWS</h4>
<p>You now have a valid certificate, <code>zymkey.crt</code>, signed by the Certificate Authority of your choice. Next you have to register your Certificate Authority with Amazon&rsquo;s IoT service so that AWS IoT will accept certificates signed by those Certifcate Authorities.</p>
<hr>
<p><strong>Manually</strong>:</p>
<ol>
<li>
<p>From the <strong>AWS IoT console</strong> select <strong>CA</strong> and then click <strong>Register</strong></p>
</li>
<li>
<p>Click <strong>Register CA</strong></p>
</li>
<li>
<p>Follow the directions on the next screen to create a verification certificate.</p>
</li>
<li>
<p>When signing the verification certificate with your CA in <strong>Step 4</strong> run the following command:</p>
<pre><code> openssl x509 -req -in verificationCert.csr -CA CA_files/zk_ca.pem -CAkey CA_files/zk_ca.key -CAcreateserial -out verificationCert.crt -days 500 -sha256
</code></pre>
<p>Note that if you a different CA and not the demo one we generated, to change the <strong>-CA</strong> and <strong>-CAkey</strong> paths appropriately.</p>
</li>
<li>
<p>Click <strong>Select CA certificate</strong> and point to the correct <strong>.pem file</strong>. If you use the OpenSSL generated SSL point to <strong>CA_files/zk_ca.pem</strong></p>
</li>
<li>
<p>Click <strong>Select verification certificate</strong> and point to <strong>verificationCert.crt</strong> which was created in Step 4.</p>
</li>
<li>
<p>Select <strong>Active CA certificate</strong> and <strong>Enable auto-registration of device certificates</strong></p>
</li>
</ol>
<hr>
<p><strong>Programatically:</strong></p>
<p>The following python script will automatically create a verification cert with a registration code and automatically activate your Certificate Authority. While it may look a bit intimidating, all you have to worry about is the very last line, where you can change to point to your CA files.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>OpenSSL</span>
<span class=kn>import</span> <span class=nn>boto3</span>
<span class=kn>import</span> <span class=nn>os</span>

<span class=k>def</span> <span class=nf>gen_AWS_verification_csr</span><span class=p>(</span><span class=n>registrationCode</span><span class=p>):</span>
	<span class=n>key</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>PKey</span><span class=p>()</span>
	<span class=n>key</span><span class=o>.</span><span class=n>generate_key</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>TYPE_RSA</span><span class=p>,</span> <span class=mi>2048</span><span class=p>)</span>
	<span class=n>req</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>X509Req</span><span class=p>()</span>
	<span class=n>req</span><span class=o>.</span><span class=n>get_subject</span><span class=p>()</span><span class=o>.</span><span class=n>CN</span> <span class=o>=</span> <span class=n>registrationCode</span>
	<span class=n>req</span><span class=o>.</span><span class=n>set_pubkey</span><span class=p>(</span><span class=n>key</span><span class=p>)</span>
	<span class=n>req</span><span class=o>.</span><span class=n>sign</span><span class=p>(</span><span class=n>key</span><span class=p>,</span> <span class=s2>&#34;sha256&#34;</span><span class=p>)</span>	
	<span class=k>return</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>dump_certificate_request</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>FILETYPE_PEM</span><span class=p>,</span> <span class=n>req</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>sign_CSR_with_CA</span><span class=p>(</span><span class=n>verification_csr</span><span class=p>,</span> <span class=n>CA_cert_path</span><span class=p>,</span> <span class=n>CA_key_path</span><span class=p>):</span>
	<span class=n>ca_cert</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>load_certificate</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>FILETYPE_PEM</span><span class=p>,</span> <span class=nb>open</span><span class=p>(</span><span class=n>CA_cert_path</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
	<span class=n>ca_key</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>load_privatekey</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>FILETYPE_PEM</span><span class=p>,</span> <span class=nb>open</span><span class=p>(</span><span class=n>CA_key_path</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>())</span>
	<span class=n>req</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>load_certificate_request</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>FILETYPE_PEM</span><span class=p>,</span> <span class=n>verification_csr</span><span class=p>)</span>
	<span class=n>cert</span> <span class=o>=</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>X509</span><span class=p>()</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>set_subject</span><span class=p>(</span><span class=n>req</span><span class=o>.</span><span class=n>get_subject</span><span class=p>())</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>set_serial_number</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>gmtime_adj_notBefore</span><span class=p>(</span><span class=mi>0</span><span class=p>)</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>gmtime_adj_notAfter</span><span class=p>(</span><span class=mi>24</span> <span class=o>*</span> <span class=mi>60</span> <span class=o>*</span> <span class=mi>60</span><span class=p>)</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>set_issuer</span><span class=p>(</span><span class=n>ca_cert</span><span class=o>.</span><span class=n>get_subject</span><span class=p>())</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>set_pubkey</span><span class=p>(</span><span class=n>req</span><span class=o>.</span><span class=n>get_pubkey</span><span class=p>())</span>
	<span class=n>cert</span><span class=o>.</span><span class=n>sign</span><span class=p>(</span><span class=n>ca_key</span><span class=p>,</span> <span class=s2>&#34;sha256&#34;</span><span class=p>)</span>
	<span class=k>return</span> <span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>dump_certificate</span><span class=p>(</span><span class=n>OpenSSL</span><span class=o>.</span><span class=n>crypto</span><span class=o>.</span><span class=n>FILETYPE_PEM</span><span class=p>,</span> <span class=n>cert</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>register_CA_AWS</span><span class=p>(</span><span class=n>CA_cert_path</span><span class=p>,</span> <span class=n>CA_key_path</span><span class=p>):</span>
	<span class=n>client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;iot&#39;</span><span class=p>)</span>
	
	<span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>get_registration_code</span><span class=p>()</span>
	<span class=n>registration_key</span> <span class=o>=</span> <span class=n>response</span><span class=p>[</span><span class=s1>&#39;registrationCode&#39;</span><span class=p>]</span>
	
	<span class=n>verification_pem</span> <span class=o>=</span> <span class=n>gen_AWS_verification_csr</span><span class=p>(</span><span class=n>registrationCode</span><span class=o>=</span><span class=n>registration_key</span><span class=p>)</span>
	<span class=n>verification_cert</span> <span class=o>=</span> <span class=n>sign_CSR_with_CA</span><span class=p>(</span><span class=n>verification_csr</span><span class=o>=</span><span class=n>verification_pem</span><span class=p>,</span> <span class=n>CA_cert_path</span><span class=o>=</span><span class=n>CA_cert_path</span><span class=p>,</span> <span class=n>CA_key_path</span><span class=o>=</span><span class=n>CA_key_path</span><span class=p>)</span>
	
	<span class=n>response</span> <span class=o>=</span> <span class=n>client</span><span class=o>.</span><span class=n>register_ca_certificate</span><span class=p>(</span>
		<span class=n>caCertificate</span><span class=o>=</span><span class=nb>open</span><span class=p>(</span><span class=n>CA_cert_path</span><span class=p>)</span><span class=o>.</span><span class=n>read</span><span class=p>(),</span>
		<span class=n>verificationCertificate</span><span class=o>=</span><span class=n>verification_cert</span><span class=p>,</span>
		<span class=n>setAsActive</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
		<span class=n>allowAutoRegistration</span><span class=o>=</span><span class=kc>True</span>
	<span class=p>)</span>

	<span class=k>return</span> <span class=n>response</span>

<span class=n>register_CA_AWS</span><span class=p>(</span><span class=n>CA_cert_path</span><span class=o>=</span><span class=s1>&#39;CA_files/zk_ca.crt&#39;</span><span class=p>,</span> <span class=n>CA_key_path</span><span class=o>=</span><span class=s1>&#39;CA_files/zk_ca.key&#39;</span><span class=p>)</span>	
</code></pre></div><p>Copy the above lines into a file called <code>activate_aws_ca.py</code> and run with the following command:</p>
<pre><code>python activate_aws_ca.py
</code></pre>
</details>
<hr>
<h2 id=registering-a-device-certificate-signed-by-certificate-authority>Registering a Device Certificate signed by Certificate Authority</h2>
<p>Now that your <strong>Certificate Authority</strong> has been registered with AWS IoT, all that is left to do is to register and activate your Zymkey certificate.</p>
<details>
<summary>Details</summary>
<br>
<hr>
<p><strong>Manually:</strong></p>
<ol>
<li>From the <strong>AWS IoT Console</strong> click <strong>Certificates</strong> and then click the blue <strong>Create</strong> button</li>
<li>Under <strong>Use My Certificate</strong> click the <strong>Get Started</strong> button</li>
<li>If you registered your own CA, choose the <strong>CA you registered</strong> on the Select a CA screen, then click on the <strong>Register CA</strong> button</li>
<li>Click <strong>Next</strong></li>
<li>Click <strong>Select certificate</strong> and navigate to the certificate that was signed by your CA. Its default name is <code>zymkey.crt</code></li>
<li>Make sure to check the <strong>activate</strong> circle on the certificate box, and finally click the blue <strong>Register certificates</strong> button.</li>
</ol>
<hr>
<p><strong>Programatically:</strong></p>
<p>The same thing can be done in Python. Just change the last line to point to your <strong>CA_Path</strong> and <strong>Cert_Path</strong>, the paths can be either relative or absolute. For example if the two certificate files: <code>zk_ca.crt</code> and <code>zymkey.crt</code> are in the same directory as the Python script, you don&rsquo;t have to change anything from the following:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>boto3</span>
<span class=kn>import</span> <span class=nn>OpenSSL</span>

<span class=k>def</span> <span class=nf>activate_cert_AWS</span><span class=p>(</span><span class=n>CA_path</span><span class=p>,</span> <span class=n>Cert_path</span><span class=p>):</span>
	<span class=n>boto3client</span> <span class=o>=</span> <span class=n>boto3</span><span class=o>.</span><span class=n>client</span><span class=p>(</span><span class=s1>&#39;iot&#39;</span><span class=p>)</span>
	<span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>CA_path</span><span class=p>)</span> <span class=k>as</span> <span class=n>CA_file</span><span class=p>:</span>
               <span class=n>CA_Pem</span> <span class=o>=</span> <span class=n>CA_file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
        <span class=k>with</span> <span class=nb>open</span><span class=p>(</span><span class=n>Cert_path</span><span class=p>)</span> <span class=k>as</span> <span class=n>Cert_file</span><span class=p>:</span>
                <span class=n>Cert_Pem</span> <span class=o>=</span> <span class=n>Cert_file</span><span class=o>.</span><span class=n>read</span><span class=p>()</span>
        <span class=k>return</span> <span class=n>boto3client</span><span class=o>.</span><span class=n>register_certificate</span><span class=p>(</span>
		<span class=n>certificatePem</span><span class=o>=</span><span class=n>Cert_Pem</span><span class=p>,</span>
		<span class=n>caCertificatePem</span><span class=o>=</span><span class=n>CA_Pem</span><span class=p>,</span>
		<span class=n>setAsActive</span><span class=o>=</span><span class=kc>True</span><span class=p>,</span>
	<span class=p>)</span>
	
<span class=n>activate_cert_AWS</span><span class=p>(</span><span class=n>CA_path</span><span class=o>=</span><span class=s1>&#39;CA_files/zk_ca.crt&#39;</span><span class=p>,</span> <span class=n>Cert_path</span><span class=o>=</span><span class=s1>&#39;zymkey.crt&#39;</span><span class=p>)</span> 
</code></pre></div><p>Copy the above lines into a file called <code>activate_aws_cert.py</code> and run with the following command: Change the CA_Path and Cert_path if necessary.</p>
<pre><code>python activate_aws_cert.py
</code></pre>
</details>
<hr>
<h2 id=testing-tls-connection-with-zymkey-device-certificate>Testing TLS connection with Zymkey Device Certificate:</h2>
<p>You can now test that your certificate <code>zymkey.crt</code> has been registered correctly by testing a TLS connection with your AWS IoT endpoint. We will be doing this with CURL.</p>
<details>
<summary>Details</summary>
<br>
<p>The first thing to do is to look for your AWS endpoint:</p>
<ol>
<li>
<p>From the <strong>AWS IoT console screen</strong>, click on <strong>Settings</strong> in the left hand bar.</p>
</li>
<li>
<p>In the <strong>Device data endpoint</strong> section, copy the <strong>Endpoint</strong>.</p>
</li>
<li>
<p>Replace <strong>endpoint.iot.region</strong> with the <strong>Endpoint</strong> you just copied in the following command. Now run the command, making sure to do it in the same directory where you keep your signed certificate, <code>zymkey.crt</code> and your CA cert/pem file, *<code>AWS_CA.pem</code>, or <code>CA_files/zk_ca.pem</code>:</p>
<pre><code>#replace endpoint iot region with the copied endpoint
curl --tlsv1.2 --cacert AWS_CA.pem --cert zymkey.crt --key nonzymkey.key --engine zymkey_ssl --key-type ENG -v -X POST -d &quot;{ \&quot;hello\&quot;: \&quot;world\&quot;}&quot; &quot;https://endpoint.iot.region.amazonaws.com:8443/topics/hello/world&quot;
</code></pre>
</li>
</ol>
<p>You should see a successful TLS connection, but receive a <strong>403 Forbidden Exception</strong> from AWS. This is because the certificate you registered, <code>zymkey.crt</code> doesn&rsquo;t have the appropriate permissions to publish a message to the topic <strong>hello/world</strong>. We can fix this by adding a policy and attaching it to the certificate.</p>
<hr>
<p>Here&rsquo;s what the <strong>successful TLS connection</strong> looks like:</p>
<p><img src=tls-success.png alt=tls-success|690x161></p>
<hr>
<p>Here&rsquo;s the <strong>403 exception</strong> you should receive:</p>
<p><img src=tls-403exception.png alt=403-except|581x164></p>
</details>
<hr>
<h2 id=attaching-policy-to-certificate-and-publishing-to-aws-iot>Attaching Policy to Certificate and Publishing to AWS IoT</h2>
<details>
<summary>Details</summary>
<br>
<p>Here we will attach a Policy to your Zymkey certificate that allows it to publish data to any topic on AWS IoT.</p>
<ol>
<li>
<p>From the <strong>AWS IoT</strong> console click on <strong>Secure</strong> and then <strong>Policies</strong>. Click the blue <strong>Create a policy</strong> button.</p>
</li>
<li>
<p>Give your Policy an approriate name.</p>
</li>
<li>
<p>Under <strong>Action</strong>, write the following:</p>
<pre><code> iot:Connect, iot:Publish
</code></pre>
</li>
<li>
<p>For <strong>Resource ARN</strong> write:</p>
<pre><code> *
</code></pre>
</li>
<li>
<p>Check the <strong>Allow</strong> box, and click <strong>Create</strong></p>
</li>
<li>
<p>Now, click the <strong>Certificates</strong> tab on the left and click on the <strong>&mldr;</strong> option on the top right corner of your certificate. Select <strong>Attach Policy</strong></p>
</li>
<li>
<p>Attach the appropriate policy and you are done.</p>
</li>
</ol>
</details>
<hr>
<h2 id=publishing-data-to-aws-iot>Publishing data to AWS IoT</h2>
<details>
<summary>Details</summary>
<br>
<p>Now the previous command should work and <strong>{&ldquo;hello&rdquo;: &ldquo;world&rdquo;}</strong> should be published to the <strong>hello/world</strong> topic on your AWS IoT endpoint.</p>
<ol>
<li>
<p>On the <strong>AWS IoT console</strong> and the <strong>left hand bar</strong>, click on the <strong>Test</strong> option.</p>
</li>
<li>
<p>In the <strong>Subscribe to a topic</strong> tab, in the <strong>Topic filter</strong> box, type in <strong>hello/world</strong>. Click the <strong>Subscribe</strong> button</p>
</li>
<li>
<p>Test your TLS connection with the following <strong>CURL</strong> command pointing to the <strong>CA cert/pem file</strong> and your <strong>Zymkey certificate</strong>:</p>
<pre><code> #replace endpoint.iot.region with the appropriate values
 curl --tlsv1.2 --cacert CA_files/zk_ca.pem --cert zymkey.crt --key nonzymkey.key --engine zymkey_ssl --key-type ENG -v -X POST -d &quot;{ \&quot;hello\&quot;: \&quot;world\&quot;}&quot; &quot;https://endpoint.iot.region.amazonaws.com:8443/topics/hello/world&quot;
</code></pre>
</li>
</ol>
<p>If it works, your command line should have indication of successful TLS connection and <strong>&ldquo;hello&rdquo;: &ldquo;world&rdquo;</strong> should show up in your subscribed topic.</p>
</details>
</div>
</main>
</div>
</div>
<footer class="bg-dark py-5 row d-print-none">
<div class="container-fluid mx-sm-5">
<div class=row>
<div class="col-6 col-sm-4 text-xs-center order-sm-2">
</div>
<div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
</div>
<div class="col-12 col-sm-4 text-center py-2 order-sm-2">
</div>
</div>
</div>
</footer>
</div>
<script src=https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js integrity=sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN crossorigin=anonymous></script>
<script src=https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js integrity=sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF crossorigin=anonymous></script>
<script src=/js/tabpane-persist.js></script>
<script src=/js/main.min.90117f987c53fd91c158b0fdafdd706a652142547bf4e69cdb0a9815070485f4.js integrity="sha256-kBF/mHxT/ZHBWLD9r91wamUhQlR79Oac2wqYFQcEhfQ=" crossorigin=anonymous></script>
</body>
</html>