{{/* Works whether the theme uses "main" or "content" blocks */}}

{{ define "main" }}
  <p>DEBUG1 → Type: {{ .Type }}, Section: {{ .Section }}, Kind: {{ .Kind }}</p>
  {{ with .Content }}{{ . }}{{ end }}
  {{ template "immediate-children" . }}
{{ end }}

{{ define "content" }}
  {{ with .Content }}{{ . }}{{ end }}
  {{ template "immediate-children" . }}
{{ end }}

{{ define "immediate-children" }}
  {{ if .IsSection }}
    <p>DEBUG: Sections count: {{ len .Sections }}</p>
    <p>Regular pages count: {{ len .RegularPages }}</p>

    {{ range .Sections }}
      <p>SECTION → {{ .Title }} ({{ .File.Path }})</p>
    {{ end }}
    {{ range .RegularPages }}
      <p>PAGE → {{ .Title }} ({{ .File.Path }})</p>
    {{ end }}

    {{/* Gather and merge (avoid union; keep as Pages) */}}
    {{ $children := slice | append .Sections | append .RegularPages }}

    {{ range $children }}<p>DEBUG: {{ .Title }} — Weight: {{ .Weight }} — Kind: {{ .Kind }}</p>{{ end }}

    {{/* Filters */}}
    {{ $children = where $children ".Params.hide_summary" "!=" true }}
    {{ $children = where $children "Type" "!=" "search" }}

    {{/* Sort: weight asc, then link title asc (or Title) */}}
    {{ $children = sort $children "Weight" "asc" "LinkTitle" "asc" }}

    {{ if or .Params.no_list (eq (len $children) 0) }}
      {{/* nothing */}}
    {{ else if .Params.simple_list }}
      <ul>
        {{ range $children }}
          {{/* Fix param casing: check and read the same key */}}
          {{ $hasManual := isset .Params "manualLink" }}
          {{ $manualLink := cond $hasManual
              .Params.manualLink
              (cond (isset .Params "manualLinkRelref") (relref . .Params.manualLinkRelref) .RelPermalink) }}
          <li>
            <a href="{{ $manualLink }}"
               {{ with .Params.manualLinkTitle }} title="{{ . }}"{{ end }}
               {{ with .Params.manualLinkTarget }} target="{{ . }}"{{ if eq . "_blank" }} rel="noopener"{{ end }}{{ end }}>
              {{- .LinkTitle | default .Title -}}
            </a>
          </li>
        {{ end }}
      </ul>
    {{ else }}
      <hr class="panel-line">
      {{ range $children }}<p>{{ .Title }} — Weight2: {{ .Weight }} — Kind: {{ .Kind }}</p>{{ end }}
      {{ range $children }}
        {{ $hasManual := isset .Params "manualLink" }}
        {{ $manualLink := cond $hasManual
            .Params.manualLink
            (cond (isset .Params "manualLinkRelref") (relref . .Params.manualLinkRelref) .RelPermalink) }}
        <div class="entry">
          <h5>
            <a href="{{ $manualLink }}"
               {{ with .Params.manualLinkTitle }} title="{{ . }}"{{ end }}
               {{ with .Params.manualLinkTarget }} target="{{ . }}"{{ if eq . "_blank" }} rel="noopener"{{ end }}{{ end }}>
              {{- .LinkTitle | default .Title -}}
            </a>
          </h5>
          <p>{{ .Description | markdownify }}</p>
        </div>
      {{ end }}
    {{ end }}
  {{ end }}
{{ end }}

