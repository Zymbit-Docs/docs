name: Push Repo to Staging Mirror

on:
  - push
  - delete
  - create
  - workflow_dispatch

env:
  IS_CREATION_EVENT: ${{ contains('push, create, workflow_dispatch', github.event_name) }}
  IS_PRIMARY: ${{ github.ref == 'refs/heads/main' || github.ref == 'refs/heads/gh-pages' }}
jobs:
  mirror-branch:
    runs-on: ubuntu-latest
    if: ${{ env.IS_CREATION_EVENT && !env.ISPRIMARY }}

    steps:
      - name: "[debug] evaluate expression"
        run: |
          echo -e "::debug::IS_CREATION_EVENT: ${IS_CREATION_EVENT}"
          echo -e "::debug::IS_PRIMARY: ${IS_PRIMARY}"
          IF_EXPR=${{ env.IS_CREATION_EVENT && !env.ISPRIMARY }}

          echo -e "::debug::IF_EXPR: ${IF_EXPR}"
      - name: load ssh private key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.STAGING_DEPLOY_KEY }}
        run: |
          mkdir -p ${HOME}/.ssh

          cp /etc/ssh/ssh_config ${HOME}/.ssh/config || true
          echo -e "Host *\n\tStrictHostKeyChecking no" >> ${HOME}/.ssh/config

          echo "${SSH_PRIVATE_KEY}" > ${HOME}/.ssh/id_rsa
          chmod 600 ${HOME}/.ssh/id_rsa

      # Checkout repository under $GITHUB_WORKSPACE
      - uses: actions/checkout@v2
        with:
          submodules: true
          fetch-depth: 0

      - name: configure mirror
        env:
          MIRROR_REPO: ${{ secrets.MIRROR_REPO }}
        run: |
          cd ${GITHUB_WORKSPACE}

          git remote add staging "${MIRROR_REPO}"
          git remote remove origin

          git push --force staging ${{ github.ref }}
